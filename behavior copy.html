<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>è¨ªå®¢è¡Œç‚ºè¨˜éŒ„åˆ†æç³»çµ±</title>
    <style>
        /* --- é é¢ä½ˆå±€èˆ‡æ¨£å¼ --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f7f9; }
        /* ç§»é™¤æœ€å¤§å¯¬åº¦é™åˆ¶ */
        .container { display: flex; gap: 20px; margin: 0 auto; } 
        .control-panel { flex: 0 0 350px; /* å›ºå®šæ§åˆ¶é¢æ¿å¯¬åº¦ */ background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .map-section { flex: 1; /* è®“åœ°åœ–å€åŸŸç›¡å¯èƒ½å¯¬ */ background-color: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }

        /* --- åœ°åœ–èˆ‡æ¨™è¨˜æ¨£å¼ --- */
        #map-container { 
            position: relative; 
            display: inline-block; 
            cursor: crosshair; 
            border: 1px solid #ccc;
            /* è®“åœ°åœ–å®¹å™¨å¯ä»¥ä¼¸ç¸® */
            width: 100%; 
            min-height: 400px;
        }

        /* é—œéµä¿®æ­£: è®“æ‰€æœ‰åœ°åœ–åœ–ç‰‡å †ç–Šåœ¨ map-container ä¸­ï¼Œä¸¦æ§åˆ¶é¡¯ç¤º */
        .map-image { 
            max-width: 100%; 
            height: auto; 
            display: none; 
            position: absolute; 
            top: 0;
            left: 0;
        }
        .map-image.active {
            display: block; 
        }

        /* æ¨™è¨˜æ¨£å¼ä¿æŒä¸è®Š */
        .marker {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: #007bff; 
            border-radius: 50%;
            border: 2px solid white;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            z-index: 10; 
        }
        .marker:hover { background-color: #0056b3; }
        .marker-name {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .marker:hover .marker-name { opacity: 1; }

        /* --- è¡¨å–®æ§åˆ¶æ¨£å¼ --- */
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        select, input[type="text"] { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; transition: background-color 0.2s; }
        .primary-btn { background-color: #28a745; }
        .primary-btn:hover { background-color: #1e7e34; }
        .secondary-btn { background-color: #007bff; margin-top: 10px;}
        .secondary-btn:hover { background-color: #0056b3; }

        .data-export-section { text-align: right; }
        .data-export-section a { text-decoration: none; }

    </style>
</head>
<body>

    <h1>ğŸ“Š è¨ªå®¢è¡Œç‚ºè¨˜éŒ„åˆ†æç³»çµ±</h1>
    <div class="container">
        
        <div class="control-panel">
            <h2>ğŸ“Œ è¨˜éŒ„æ§åˆ¶å°</h2>

            <div class="input-group">
                <label for="visitor-category-select">è¨ªå®¢åˆ†é¡</label>
                <select id="visitor-category-select"></select>
                <input type="text" id="new-category-input" placeholder="æ–°å¢è¨ªå®¢é¡åˆ¥åç¨±">
                <button onclick="addCategory()" class="primary-btn" style="width: 100%;">æ–°å¢æˆ–é¸æ“‡é¡åˆ¥</button>
            </div>

            <hr>

            <div class="input-group">
                <label for="action-select">è¡Œç‚ºè¨˜éŒ„</label>
                <select id="action-select"></select>
                <input type="text" id="new-action-input" placeholder="æ–°å¢è¡Œç‚ºåç¨±">
                <button onclick="addAction()" class="primary-btn" style="width: 100%;">æ–°å¢æˆ–é¸æ“‡è¡Œç‚º</button>
            </div>

            <hr>
            
            <h3>ç•¶å‰è¨˜éŒ„ç‹€æ…‹</h3>
            <p>åˆ†é¡: <strong id="current-category">æœªé¸æ“‡</strong></p>
            <p>ä½ç½®: <strong id="current-location">æœªé»æ“Š</strong></p>
            <p>è¡Œç‚º: <strong id="current-action">æœªé¸æ“‡</strong></p>
            <p>
                <button id="record-button" onclick="recordBehavior()" class="primary-btn" style="width: 100%; background-color: #dc3545;" disabled>
                    é–‹å§‹è¨˜éŒ„æ­¤è¡Œç‚º
                </button>
            </p>
            
            <hr>

            <div class="data-export-section">
                <a href="log-viewer.html">
                    <button class="secondary-btn" style="width: 100%;">æŸ¥çœ‹æ‰€æœ‰è¨˜éŒ„èˆ‡åŒ¯å‡º</button>
                </a>
            </div>
        </div>

        <div class="map-section">
            
            <h2>ğŸ—ºï¸ ä½ç½®è¨˜éŒ„ (é»æ“Šåœ°åœ–)</h2>
            <div class="input-group">
                <label for="map-select">é¸æ“‡å¹³é¢åœ–</label>
                <select id="map-select">
                    <option value="map-image1" selected>å°ç£æ°´åŸŸé¤¨å¹³é¢åœ–</option>
                    <option value="map-image2">çŠç‘šç‹åœ‹é¤¨å¹³é¢åœ–</option>
                    <option value="map-image3">ä¸–ç•Œæ°´åŸŸé¤¨1,2Få¹³é¢åœ–</option>
                    <option value="map-image4">ä¸–ç•Œæ°´åŸŸé¤¨3Få¹³é¢åœ–</option>
                </select>
            </div>

            <div id="map-container">
                <img id="map-image1" class="map-image" src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/f9f83808-8917-4d91-be95-98955736b763.jpg" alt="å°ç£æ°´åŸŸé¤¨å¹³é¢åœ–">
                <img id="map-image2" class="map-image active" src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/aeee9399-5776-4dc9-bc34-74f3de9610ad.jpg" alt="çŠç‘šç‹åœ‹é¤¨å¹³é¢åœ–">
                <img id="map-image3" class="map-image" src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/be3ac2e6-4910-4308-9c19-d797081ea4e1.jpg" alt="ä¸–ç•Œæ°´åŸŸé¤¨1,2Få¹³é¢åœ–">
                <img id="map-image4" class="map-image" src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/c7e10c76-a9aa-49ea-abe4-81066e8fd518.jpg" alt="ä¸–ç•Œæ°´åŸŸé¤¨3Få¹³é¢åœ–">
            </div>
            
        </div>
    </div>

    <script>
// --- è¨­å®š ---
const DISTANCE_THRESHOLD = 10; 
const CATEGORY_KEY = 'visitorCategories';
const ACTION_KEY = 'visitorActions';
const LOCATION_KEY = 'locationMarkers';
const LOG_KEY = 'behaviorLog';

// --- DOM å…ƒç´ å¿«å– ---
const mapContainer = document.getElementById('map-container');
const mapImages = document.querySelectorAll('.map-image'); 
const mapSelect = document.getElementById('map-select');
const categorySelect = document.getElementById('visitor-category-select');
const actionSelect = document.getElementById('action-select');
const currentCategory = document.getElementById('current-category');
const currentLocation = document.getElementById('current-location');
const currentAction = document.getElementById('current-action');
const recordButton = document.getElementById('record-button');

// --- ç‹€æ…‹è®Šæ•¸ ---
let locations = loadData(LOCATION_KEY);
let categories = loadData(CATEGORY_KEY, ['ä¸€èˆ¬éŠå®¢', 'å­¸ç”Ÿåœ˜é«”', 'å¹´é•·è€…']); 
let actions = loadData(ACTION_KEY, ['åœç•™è§€çœ‹', 'å¿«é€Ÿç§»å‹•', 'ä½¿ç”¨æ‰‹æ©Ÿ', 'äº’å‹•é«”é©—']); 
let logData = loadData(LOG_KEY);

let selectedMapID = mapSelect.value; 
let selectedCategory = '';
let selectedLocation = '';
let selectedAction = '';
let currentActiveMapElement = null; 

// --- è¼”åŠ©å‡½æ•¸ ---
function loadData(key, defaultData = []) {
    const data = localStorage.getItem(key);
    return data ? JSON.parse(data) : defaultData;
}

function saveData(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
}

function getDistanceSq(x1, y1, x2, y2) {
    return Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2);
}

// --- 1. è¨ªå®¢åˆ†é¡æ“ä½œæ­¥é©Ÿ ---
function initCategory() {
    populateSelect(categorySelect, categories);
    categorySelect.onchange = () => {
        selectedCategory = categorySelect.value;
        currentCategory.textContent = selectedCategory;
        checkRecordButtonStatus();
    };
    if (categories.length > 0) {
        categorySelect.value = categories[0];
        categorySelect.onchange(); 
    }
}

function addCategory() {
    const input = document.getElementById('new-category-input');
    const newName = input.value.trim();
    
    if (newName && !categories.includes(newName)) {
        categories.push(newName);
        saveData(CATEGORY_KEY, categories);
        populateSelect(categorySelect, categories);
        categorySelect.value = newName;
    }
    selectedCategory = categorySelect.value || newName;
    currentCategory.textContent = selectedCategory;
    input.value = '';
    checkRecordButtonStatus();
}

// --- 3. è¡Œç‚ºè¨˜éŒ„æ“ä½œæ­¥é©Ÿ ---
function initAction() {
    populateSelect(actionSelect, actions);
    actionSelect.onchange = () => {
        selectedAction = actionSelect.value;
        currentAction.textContent = selectedAction;
        checkRecordButtonStatus();
    };
    if (actions.length > 0) {
        actionSelect.value = actions[0];
        actionSelect.onchange(); 
    }
}

function addAction() {
    const input = document.getElementById('new-action-input');
    const newName = input.value.trim();
    
    if (newName && !actions.includes(newName)) {
        actions.push(newName);
        saveData(ACTION_KEY, actions);
        populateSelect(actionSelect, actions);
        actionSelect.value = newName;
    }
    selectedAction = actionSelect.value || newName;
    currentAction.textContent = selectedAction;
    input.value = '';
    checkRecordButtonStatus();
}

// å¡«å……ä¸‹æ‹‰é¸å–®çš„é€šç”¨å‡½æ•¸
function populateSelect(selectElement, data) {
    selectElement.innerHTML = '';
    data.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        selectElement.appendChild(option);
    });
}

// --- 2. ä½ç½®æ“ä½œæ­¥é©Ÿ ---
function switchMap() {
    const newMapID = mapSelect.value;
    selectedMapID = newMapID;
    selectedLocation = ''; 
    currentLocation.textContent = 'æœªé»æ“Š';
    checkRecordButtonStatus();

    mapImages.forEach(img => {
        img.classList.remove('active');
        if (img.id === newMapID) {
            img.classList.add('active');
            currentActiveMapElement = img; 
        }
    });

    renderMarkers();
}

function renderMarkers() {
    mapContainer.querySelectorAll('.marker').forEach(m => m.remove());
    const currentMapMarkers = locations.filter(loc => loc.map === selectedMapID);

    currentMapMarkers.forEach((loc, index) => {
        const markerDiv = document.createElement('div');
        markerDiv.className = 'marker';
        markerDiv.style.left = `${loc.x}px`;
        markerDiv.style.top = `${loc.y}px`;
        markerDiv.dataset.index = index;
        markerDiv.title = `${loc.name} (${loc.x}, ${loc.y})`;

        const nameSpan = document.createElement('span');
        nameSpan.className = 'marker-name';
        nameSpan.textContent = loc.name;

        markerDiv.appendChild(nameSpan);
        mapContainer.appendChild(markerDiv);
    });
}

mapContainer.addEventListener('click', (event) => {
    // å¦‚æœé»æ“Šç›®æ¨™æ˜¯ marker æœ¬èº«æˆ–å…¶å­å…ƒç´ ï¼Œå‰‡ä¸è§¸ç™¼æ–°å¢é»æ“Šäº‹ä»¶ï¼Œè®“ marker ä¿æŒè¢«é¸ä¸­
    if (event.target.classList.contains('marker') || event.target.closest('.marker')) {
        // å¦‚æœæ˜¯é»æ“Šæ—¢æœ‰çš„ markerï¼Œå‰‡æ˜ç¢ºé¸ä¸­è©²ä½ç½®
        const markerElement = event.target.closest('.marker');
        const locationName = markerElement.querySelector('.marker-name').textContent;
        selectedLocation = locationName;
        currentLocation.textContent = selectedLocation;
        checkRecordButtonStatus();
        return; 
    }

    if (!currentActiveMapElement) {
        return;
    }

    const rect = mapContainer.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;
    
    const thresholdSq = Math.pow(DISTANCE_THRESHOLD, 2);

    let foundLocation = null;
    let closestDistanceSq = Infinity;
    
    const currentMapLocations = locations.filter(loc => loc.map === selectedMapID);

    for (const loc of currentMapLocations) {
        const distSq = getDistanceSq(x, y, loc.x, loc.y);
        if (distSq < closestDistanceSq) {
            closestDistanceSq = distSq;
            if (distSq <= thresholdSq) {
                foundLocation = loc;
            }
        }
    }

    if (foundLocation) {
        // ã€ä¿®æ­£é» 1ã€‘å¦‚æœæ‰¾åˆ°ç¾æœ‰ä½ç½®ï¼Œå‰‡è¨­å®š selectedLocation
        selectedLocation = foundLocation.name;
    } else {
        // å¦‚æœä¸æ˜¯æ—¢æœ‰ä½ç½®ï¼Œå‰‡æç¤ºå‘½å
        const newName = prompt(`æ‚¨é»æ“Šçš„åº§æ¨™æ˜¯ (X: ${Math.round(x)}, Y: ${Math.round(y)})ã€‚è«‹ç‚ºé€™å€‹æ–°ä½ç½®å‘½åï¼š`);
        if (newName) {
            const existingLoc = locations.find(loc => loc.name === newName);
            if (existingLoc) {
                 alert(`ä½ç½®åç¨± "${newName}" å·²å­˜åœ¨æ–¼åœ°åœ– "${existingLoc.map}"ã€‚è«‹é‡æ–°å‘½åæˆ–é»æ“Šç¾æœ‰æ¨™è¨˜ã€‚`);
            } else {
                locations.push({ name: newName, x: Math.round(x), y: Math.round(y), map: selectedMapID });
                saveData(LOCATION_KEY, locations);
                renderMarkers();
                selectedLocation = newName;
                alert(`å·²æ–°å¢ä½ç½®ï¼š${selectedLocation}`);
            }
        } else {
            selectedLocation = ''; 
        }
    }

    // ã€ä¿®æ­£é» 2 & 3ã€‘çµ±ä¸€æ›´æ–°ç‹€æ…‹é¡¯ç¤ºå’Œæª¢æŸ¥æŒ‰éˆ•ç‹€æ…‹
    currentLocation.textContent = selectedLocation || 'æœªé»æ“Š';
    checkRecordButtonStatus();
});

mapSelect.addEventListener('change', switchMap);

// --- è¨˜éŒ„ ---
function checkRecordButtonStatus() {
    const isReady = selectedCategory && selectedLocation && selectedAction;
    recordButton.disabled = !isReady;
    recordButton.textContent = isReady ? `è¨˜éŒ„: ${selectedCategory} åœ¨ ${selectedLocation} çš„ ${selectedAction}` : 'è«‹å®Œæˆæ‰€æœ‰é¸æ“‡';
    recordButton.style.backgroundColor = isReady ? '#28a745' : '#dc3545';
}

function recordBehavior() {
    if (!selectedCategory || !selectedLocation || !selectedAction) {
        alert('è«‹å…ˆå®Œæˆ è¨ªå®¢åˆ†é¡ã€ä½ç½®é»æ“Š å’Œ è¡Œç‚ºè¨˜éŒ„ çš„é¸æ“‡ï¼');
        return;
    }

    const now = new Date();
    const timestamp = now.toLocaleString('zh-TW', { hour12: false });
    
    const locationData = locations.find(loc => loc.name === selectedLocation);

    const newLog = {
        timestamp: timestamp,
        category: selectedCategory,
        location: selectedLocation,
        action: selectedAction,
        map: mapSelect.options[mapSelect.selectedIndex].text, 
        coords: locationData ? `(${locationData.x}, ${locationData.y})` : 'N/A'
    };

    logData.unshift(newLog); 
    saveData(LOG_KEY, logData);
    
    alert(`è¨˜éŒ„æˆåŠŸï¼\n[${timestamp}] ${newLog.category} åœ¨ ${newLog.location} åŸ·è¡Œ ${newLog.action}`);
}


// --- åˆå§‹åŒ–å…¨éƒ¨åŠŸèƒ½ ---
function initApp() {
    initCategory();
    initAction();
    switchMap(); 
    checkRecordButtonStatus();
}

// ç¢ºä¿æ‰€æœ‰åœ–ç‰‡è¼‰å…¥å®Œæˆå¾Œæ‰åŸ·è¡Œåˆå§‹åŒ–
let loadedCount = 0;
const totalImages = mapImages.length;
mapImages.forEach(img => {
    if (img.complete) {
        loadedCount++;
    } else {
        img.onload = () => {
            loadedCount++;
            if (loadedCount === totalImages) {
                initApp();
            }
        };
    }
});
if (loadedCount === totalImages) {
    initApp();
}
    </script>
</body>
</html>