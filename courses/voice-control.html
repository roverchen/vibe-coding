<!doctype html>
<html lang="zh-Hant">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
        <title>BLE èªéŸ³æ§åˆ¶ (Mobile)</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            /* ç¢ºä¿å…¨è¢å¹•é«˜åº¦å’ŒæŸ”è»Ÿçš„èƒŒæ™¯è‰² */
            body {
                background-color: #1f2937;
                color: #f9fafb;
                font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                margin: 0;
                padding: 1rem;
            }
            .container-wrap {
                max-width: 400px;
                width: 100%;
                padding: 20px;
                background-color: #1f2937; /* èˆ‡ body èƒŒæ™¯ä¸€è‡´ */
                border-radius: 1rem;
                box-shadow: 10px 10px 20px #171d26, -10px -10px 20px #273142;
            }
            /* é ‚éƒ¨æ§åˆ¶åˆ— */
            .top{width:100%;display:flex;gap:8px;align-items:center; max-width: 520px; margin-bottom: 20px;}
            button{padding:10px 14px;border-radius:12px;border:none;background:#4f46e5;color:white;font-weight:700;box-shadow: 3px 3px 6px #1a202c, -3px -3px 6px #273142; transition: all 0.15s ease-in-out; white-space: nowrap;}
            button:hover { background: #3730a3; box-shadow: 5px 5px 10px #1a202c, -5px -5px 10px #273142;}

            #status{flex:1;text-align:center;font-weight:700;color:#f9fafb; padding: 10px; background: #2d3748; border-radius: 12px; box-shadow: inset 3px 3px 6px #1a202c, inset -3px -3px 6px #273142;}

            /* ç‹€æ…‹æ–‡å­— */
            #main-status { font-weight: 700; text-shadow: 0 0 5px rgba(79, 70, 229, 0.5); }
            .info{font-size:14px;color:#9ca3af; margin-top: 20px;}

            /* æ–°å¢èªéŸ³æ§åˆ¶æŒ‰éˆ•æ¨£å¼ */
            #btnSpeech {
                background-color: #ef4444; /* ç´…è‰² */
                color: white;
                font-size: 1.25rem;
                padding: 1.5rem;
                width: 100%;
                height: 150px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-top: 20px;
                box-shadow: 5px 5px 10px #1a202c, -5px -5px 10px #273142;
                animation: pulse 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
            }
            #btnSpeech.listening {
                background-color: #10b981; /* ç¶ è‰² */
                box-shadow: 0 0 10px #10b981, 0 0 20px #10b981;
                animation: none;
            }
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: .5; }
            }

            #speech-result {
                min-height: 2.5rem;
                padding: 10px;
                background: #2d3748;
                border-radius: 8px;
                margin-top: 15px;
                font-style: italic;
            }
        </style>
    </head>
    <body class="p-4">
        <div class="container-wrap">

            <h1 class="text-3xl font-extrabold text-center text-indigo-400 mb-6">ğŸ™ï¸ BLE èªéŸ³æ§åˆ¶</h1>

            <div class="top">
                <button id="btnConnect" class="flex-grow">é€£ç·š BLE</button>
                <div id="status">æœªé€£ç·š</div>
            </div>

            <button id="btnSpeech">
                é»æ“Šé–‹å§‹èªéŸ³æ§åˆ¶
            </button>

            <div id="speech-result" class="text-center text-gray-400">
                èªªå‡º: å‰é€² | å¾Œé€€ | å·¦è½‰ | å³è½‰ | åœæ­¢
            </div>

            <div class="text-center space-y-2 mt-4">
                <p class="text-xl">ç›®å‰å‘½ä»¤: <span id="main-status" class="text-green-400">éœæ­¢</span></p>
                <p class="text-xs text-gray-500">
                    T (é€Ÿåº¦): <span id="val_t">0</span> | S (è½‰å‘): <span id="val_s">0</span>
                </p>
            </div>        
        </div>

        <script>
            // --- BLE & Control Configuration ---
            const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-000000000000';Â 
            const CHARACTERISTIC_UUID = '4fafc201-1fb5-459e-8fcc-000000000000';Â 
            const DEVICE_ID_KEY = 'ble_joystick_device_id';Â 
            const MAX_CONTROL_VALUE = 255;Â 

            // èªéŸ³å‘½ä»¤å°æ‡‰çš„é¦¬é”æ§åˆ¶å€¼ (T, S)
            const COMMANDS = {
                "å‰é€²": {t: MAX_CONTROL_VALUE, s: 0, status: "å‰é€²ä¸­", color: "text-green-400"},
                "å¾Œé€€": {t: -MAX_CONTROL_VALUE, s: 0, status: "å¾Œé€€ä¸­", color: "text-orange-400"},
                "å·¦è½‰": {t: 0, s: -MAX_CONTROL_VALUE, status: "å·¦è½‰ä¸­", color: "text-blue-400"},
                "å³è½‰": {t: 0, s: MAX_CONTROL_VALUE, status: "å³è½‰ä¸­", color: "text-blue-400"},
                "åœæ­¢": {t: 0, s: 0, status: "éœæ­¢", color: "text-red-400"},
                "åœ": {t: 0, s: 0, status: "éœæ­¢", color: "text-red-400"}, // å¢åŠ ã€Œåœã€ä½œç‚ºåˆ¥å
            };
            const COMMAND_KEYWORDS = Object.keys(COMMANDS);

            // --- DOM Elements ---
            const statusEl = document.getElementById('status'); // BLE é€£ç·šç‹€æ…‹
            const mainStatusEl = document.getElementById('main-status'); // ç›®å‰å‘½ä»¤ç‹€æ…‹
            const valTEl = document.getElementById('val_t'); // T (Throttle)
            const valSEl = document.getElementById('val_s'); // S (Steer)
            const btnConnect = document.getElementById('btnConnect');
            const btnSpeech = document.getElementById('btnSpeech'); // èªéŸ³æ§åˆ¶æŒ‰éˆ•
            const speechResultEl = document.getElementById('speech-result');

            // --- State Variables ---
            let device = null;
            let characteristic = null;
            let lastPayload = {t: 0, s: 0}; // å„²å­˜ä¸Šæ¬¡ç™¼é€çš„ T, S å€¼

            // --- Helper Functions ---

            /**
            * æ›´æ–°é¦¬é”æ•¸å€¼ä¸¦ç™¼é€å‘½ä»¤
            * @param {number} t é€Ÿåº¦å€¼ (-255 åˆ° 255)
            * @param {number} s è½‰å‘å€¼ (-255 åˆ° 255)
            * @param {string} statusText é¡¯ç¤ºåœ¨ UI ä¸Šçš„å‘½ä»¤ç‹€æ…‹
            * @param {string} statusColor ç‹€æ…‹æ–‡å­—é¡è‰²
            */
            async function updateMotorValues(t, s, statusText, statusColor) {
                lastPayload.t = t;
                lastPayload.s = s;

                // æ›´æ–° UI é¡¯ç¤º
                valTEl.textContent = t;
                valSEl.textContent = s;
                mainStatusEl.textContent = statusText;
                mainStatusEl.className = `font-bold ${statusColor}`;

                // ç«‹å³ç™¼é€æ§åˆ¶å‘½ä»¤
                await sendControl();
            }

            /**
            * è™•ç†èªéŸ³è¾¨è­˜çš„çµæœ
            */
            function processSpeechResult(transcript) {
                speechResultEl.textContent = `è¾¨è­˜çµæœ: ${transcript}`;

                // æª¢æŸ¥æ˜¯å¦åŒ…å«ä»»ä½•å‘½ä»¤é—œéµå­—
                for (const keyword of COMMAND_KEYWORDS) {
                    if (transcript.includes(keyword)) {
                        const command = COMMANDS[keyword];
                        updateMotorValues(command.t, command.s, command.status, command.color);
                        speechResultEl.textContent = `âœ… å‘½ä»¤åŸ·è¡Œ: ${keyword}`;
                        return; // æ‰¾åˆ°ç¬¬ä¸€å€‹å‘½ä»¤å°±åŸ·è¡Œä¸¦è¿”å›
                    }
                }

                // å¦‚æœæ²’æœ‰åŒ¹é…çš„å‘½ä»¤
                speechResultEl.textContent = `âŒ ç„¡æ•ˆå‘½ä»¤: ${transcript} (è«‹é‡è©¦)`;
                updateMotorValues(0, 0, "éœæ­¢", "text-red-400"); // ç„¡æ•ˆå‘½ä»¤æ™‚åœæ­¢é¦¬é”
            }

            // --- Web Speech API (Speech Recognition) ---

            // ç‚ºäº†æ›´å»£æ³›çš„ç€è¦½å™¨ç›¸å®¹æ€§ï¼Œä½¿ç”¨å‰ç¶´
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition = null;
            let isListening = false;

            function startSpeechRecognition() {
                if (!SpeechRecognition) {
                    alert("âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Speech API (èªéŸ³è¾¨è­˜)ã€‚è«‹ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨ã€‚");
                    return;
                }

                if (!device || !device.gatt.connected) {
                    statusEl.textContent = 'è«‹å…ˆé€£ç·š BLE è£ç½®ã€‚';
                    return;
                }

                if (isListening) {
                    recognition.stop(); // å¦‚æœæ­£åœ¨è½ï¼Œå‰‡åœæ­¢
                    return;
                }

                if (!recognition) {
                    recognition = new SpeechRecognition();
                    recognition.continuous = false; // åªè½ä¸€å€‹æŒ‡ä»¤
                    recognition.lang = 'zh-Hant'; // è¨­å®šç‚ºç¹é«”ä¸­æ–‡ (æˆ– 'cmn-Hant-TW' ä¾æ“šå¹³å°)
                    recognition.interimResults = false; // åªè¿”å›æœ€çµ‚çµæœ

                    recognition.onstart = () => {
                        isListening = true;
                        btnSpeech.textContent = "è«‹èªªè©±... (é»æ“Šåœæ­¢)";
                        btnSpeech.classList.add('listening');
                        speechResultEl.textContent = "ğŸ‘‚ æ­£åœ¨è†è½...";
                    };

                    recognition.onresult = (event) => {
                        // å–å¾—è¾¨è­˜çµæœä¸­æœ€é«˜çš„ä¿¡è³´åº¦æ–‡å­—
                        const transcript = event.results[0][0].transcript;
                        processSpeechResult(transcript);
                    };

                    recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        speechResultEl.textContent = `âŒ èªéŸ³éŒ¯èª¤: ${event.error}`;
                        stopListeningUI();
                    };

                    recognition.onend = () => {
                        stopListeningUI();
                    };
                }

                function stopListeningUI() {
                    isListening = false;
                    btnSpeech.textContent = "é»æ“Šé–‹å§‹èªéŸ³æ§åˆ¶";
                    btnSpeech.classList.remove('listening');
                }

                recognition.start();
            }

            btnSpeech.addEventListener('click', startSpeechRecognition);


            // --- BLE Connection Logic ---

            function onDisconnect() {
                statusEl.textContent = 'âŒ å·²æ–·ç·š';
                btnConnect.textContent = 'é€£ç·š BLE';
                updateMotorValues(0, 0, "éœæ­¢", "text-red-400"); // æ–·ç·šæ™‚åœæ­¢é¦¬é”
                if (device) device.removeEventListener('gattserverdisconnected', onDisconnect);
                device = null;
                characteristic = null;
            }

            async function acquireDevice() {
                statusEl.textContent = 'æƒæä¸­ (éæ¿¾: esp32)...';
                // ç”±æ–¼ CHARACTERISTIC_UUID å·²è¢«ä¿®æ”¹ï¼Œé€™è£¡å¿…é ˆç¢ºä¿ SERVICE_UUID æ˜¯æ­£ç¢ºçš„ã€‚
                const newDevice = await navigator.bluetooth.requestDevice({
                    filters:[{ namePrefix: 'esp32' }],
                    optionalServices: [SERVICE_UUID]
                });

                localStorage.setItem(DEVICE_ID_KEY, newDevice.id);
                return newDevice;
            }

            async function connectBLE(){
                if (!navigator.bluetooth) {
                    statusEl.textContent = 'âŒ ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothã€‚';
                    return;
                }

                // è™•ç†å·²é€£ç·šç‹€æ…‹ä¸‹çš„æŒ‰éˆ•é»æ“Š (æ–·é–‹é€£ç·š)
                if (device && device.gatt && device.gatt.connected) {
                    statusEl.textContent = 'ä¸­æ–·é€£ç·šä¸­...';
                    device.gatt.disconnect();
                    return;
                }
                
                try{
                    device = await acquireDevice();
                    if (!device) throw new Error("è£ç½®æœªé€£ç·šæˆ–æœªæ‰¾åˆ°ã€‚");

                    statusEl.textContent = `é€£ç·šåˆ° ${device.name}...`;

                    device.removeEventListener('gattserverdisconnected', onDisconnect);
                    device.addEventListener('gattserverdisconnected', onDisconnect);

                    const server = await device.gatt.connect();
                    const service = await server.getPrimaryService(SERVICE_UUID);
                    characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                    statusEl.textContent = 'âœ… å·²é€£ç·š: ' + device.name;
                    btnConnect.textContent = 'æ–·é–‹';

                }catch(err){
                    console.error('BLE é€£ç·šå¤±æ•—:', err);
                    statusEl.textContent = `âŒ é€£ç·šå¤±æ•— (${err.message.slice(0, 30)}...)`;
                    btnConnect.textContent = 'é€£ç·š BLE';
                    if (device && (!device.gatt || !device.gatt.connected)) {
                        device = null;
                        localStorage.removeItem(DEVICE_ID_KEY);
                    }
                }
            }


            /**
            * å‘ ESP32 å‚³é€æ§åˆ¶æŒ‡ä»¤ (T,S)
            */
            async function sendControl(){
                if(!characteristic || !device || !device.gatt.connected) {
                    statusEl.textContent = 'æœªé€£ç·šæˆ–å·²æ–·ç·šï¼Œç„¡æ³•å‚³é€å‘½ä»¤ã€‚';
                    return;
                }

                const t_int = lastPayload.t;
                const s_int = lastPayload.s;

                // å»ºç«‹ payload æ ¼å¼: T,S (ä¾‹å¦‚: "255,0")
                const payload = `${t_int},${s_int}`;

                try{
                    await characteristic.writeValue(new TextEncoder().encode(payload));
                }catch(err){
                    console.warn('send failed (å¯èƒ½å·²æ–·ç·š):', err.message);
                    // å¦‚æœå‚³é€å¤±æ•—ï¼Œè§¸ç™¼æ–·ç·šè™•ç†
                    if (device && device.gatt && !device.gatt.connected) {
                        onDisconnect();
                    }
                }
            }

            // --- Initialization ---

            btnConnect.addEventListener('click', connectBLE);
            updateMotorValues(0, 0, "éœæ­¢", "text-red-400"); // ç¢ºä¿åˆå§‹ç‹€æ…‹ç‚ºéœæ­¢
        </script>
    </body>
</html>