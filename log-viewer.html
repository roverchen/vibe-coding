<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç ”ç©¶æ•¸æ“šå ±è¡¨ç³»çµ± - é€±æœŸåˆ†æ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .report-card { background: white; border-radius: 1rem; padding: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .table-header { @apply bg-slate-100 text-slate-600 text-[11px] font-bold uppercase p-3 border-b; }
        .table-cell { @apply p-3 border-b text-sm text-slate-700; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        
        <div class="no-print space-y-4 mb-8">
            <div class="flex justify-between items-center">
                <button onclick="history.back()" class="text-indigo-600 font-bold flex items-center gap-1">
                    â¬…ï¸ è¿”å›ç´€éŒ„
                </button>
                <div class="flex gap-2">
                    <button onclick="window.print()" class="bg-slate-700 text-white px-4 py-2 rounded-lg text-sm">åˆ—å°å ±è¡¨</button>
                </div>
            </div>

            <div class="bg-indigo-600 p-6 rounded-2xl shadow-lg text-white">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">ğŸ“… å ±è¡¨æ™‚é–“é€±æœŸç¯©é¸</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onclick="filterData('day')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 transition-all font-bold">æ—¥å ± (ä»Šæ—¥)</button>
                    <button onclick="filterData('week')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 transition-all font-bold">é€±å ± (è¿‘7æ—¥)</button>
                    <button onclick="filterData('month')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 transition-all font-bold">æœˆå ± (è¿‘30æ—¥)</button>
                    <button onclick="filterData('year')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 transition-all font-bold">å¹´å ± (ä»Šå¹´)</button>
                </div>
                <p id="filter-status" class="mt-4 text-indigo-100 text-sm italic">æ­£åœ¨é¡¯ç¤ºï¼šæ‰€æœ‰æ­·å²æ•¸æ“š</p>
            </div>
        </div>

        <div id="report-content">
            <h1 id="report-title" class="text-3xl font-black text-slate-800 mb-8 border-l-8 border-indigo-600 pl-4">è§€çœ¾è¡Œç‚ºç ”ç©¶åˆ†æå ±è¡¨</h1>

            <div class="report-card">
                <h3 class="font-black text-indigo-600 mb-4 text-lg">è¡¨ 4-1ï¼šæˆå“¡çµ„åˆç´€éŒ„æ¬¡æ•¸è¡¨</h3>
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr>
                            <th class="table-header">æˆå“¡çµ„åˆé¡å‹</th>
                            <th class="table-header text-center">ç´€éŒ„æ¬¡æ•¸ (n)</th>
                            <th class="table-header text-center">ç™¾åˆ†æ¯” (%)</th>
                        </tr>
                    </thead>
                    <tbody id="table-4-1"></tbody>
                </table>
            </div>

            <div class="report-card">
                <h3 class="font-black text-indigo-600 mb-4 text-lg">è¡¨ 4-6ï¼šå®¶é•·è§€çœ¾è¡Œç‚ºæ¬¡æ•¸çµ±è¨ˆ</h3>
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr>
                            <th class="table-header">è¡Œç‚ºé …ç›®</th>
                            <th class="table-header text-center">ç¸½è¨ˆæ¬¡æ•¸</th>
                            <th class="table-header text-center">ä½”æ¯”</th>
                        </tr>
                    </thead>
                    <tbody id="table-4-6"></tbody>
                </table>
            </div>

            <div class="report-card">
                <h3 class="font-black text-indigo-600 mb-4 text-lg">è¡¨ 4-7ï¼šé«”é©—å‹•ç·šé¡å‹åˆ†å¸ƒ</h3>
                <table class="w-full text-left">
                    <thead>
                        <tr>
                            <th class="table-header">å‹•ç·šé¡å‹</th>
                            <th class="table-header text-center">å€‹æ¡ˆæ•¸</th>
                            <th class="table-header">ç‰¹å¾µèªªæ˜</th>
                        </tr>
                    </thead>
                    <tbody id="table-4-7">
                        <tr><td class="table-cell font-bold">ç›´è¡Œ (Linear)</td><td class="table-cell text-center" id="path-linear">0</td><td class="table-cell text-xs text-slate-400">ä¾åºå‰é€²ï¼Œç„¡é‡è¤‡å›é ­è·¯å¾‘</td></tr>
                        <tr><td class="table-cell font-bold">ç’°ç‹€ (Loop)</td><td class="table-cell text-center" id="path-loop">0</td><td class="table-cell text-xs text-slate-400">ç¹è¡Œç©ºé–“ä¸€åœˆå¾Œå›åˆ°èµ·é»é™„è¿‘</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const KEY = 'NMMBA_RESEARCH_FINAL';

        function filterData(period) {
            const rawData = JSON.parse(localStorage.getItem(KEY) || '[]');
            const now = new Date();
            let filtered = [];
            let periodText = "";

            filtered = rawData.filter(d => {
                // å°‡å­˜å„²çš„æ™‚é–“å­—ä¸²è½‰å› Date ç‰©ä»¶é€²è¡Œæ¯”è¼ƒ
                // è¨»ï¼šè‹¥ç´€éŒ„æ™‚åƒ…å­˜æ™‚åˆ†ç§’ï¼Œæ­¤è™•éœ€ç¢ºä¿ç´€éŒ„æ™‚æœ‰å­˜æ—¥æœŸ
                const entryDate = new Date(); 
                const [h, m, s] = d.time.split(':');
                entryDate.setHours(h, m, s);

                if (period === 'day') {
                    periodText = "ä»Šæ—¥å ±è¡¨";
                    return entryDate.toDateString() === now.toDateString();
                } else if (period === 'week') {
                    periodText = "é€±å ± (è¿‘ 7 æ—¥)";
                    const sevenDaysAgo = new Date().setDate(now.getDate() - 7);
                    return entryDate >= sevenDaysAgo;
                } else if (period === 'month') {
                    periodText = "æœˆå ± (è¿‘ 30 æ—¥)";
                    const thirtyDaysAgo = new Date().setDate(now.getDate() - 30);
                    return entryDate >= thirtyDaysAgo;
                } else if (period === 'year') {
                    periodText = "å¹´å ± (ä»Šå¹´)";
                    return entryDate.getFullYear() === now.getFullYear();
                }
                return true;
            });

            document.getElementById('filter-status').innerText = `æ­£åœ¨é¡¯ç¤ºï¼š${periodText} (${filtered.length} ç­†è³‡æ–™)`;
            document.getElementById('report-title').innerText = `è§€çœ¾è¡Œç‚ºç ”ç©¶åˆ†æ - ${periodText}`;
            renderReports(filtered);
        }

        function renderReports(data) {
            if (data.length === 0) {
                alert("è©²æ™‚æ®µå…§ç„¡æ•¸æ“šè³‡æ–™ï¼");
                return;
            }

            // --- è¡¨ 4-1 ---
            const groupMap = { '1A1C': 0, '1A2C': 0, '2A1C': 0, '2A2C': 0, 'å…¶ä»–': 0 };
            const uniqueCaseIds = [...new Set(data.map(d => d.id))];
            uniqueCaseIds.forEach(id => {
                const firstPoint = data.find(d => d.id === id);
                if (groupMap.hasOwnProperty(firstPoint.group)) groupMap[firstPoint.group]++;
            });

            document.getElementById('table-4-1').innerHTML = Object.entries(groupMap).map(([key, val]) => `
                <tr>
                    <td class="table-cell font-medium">${key}</td>
                    <td class="table-cell text-center">${val}</td>
                    <td class="table-cell text-center font-mono">${((val/uniqueCaseIds.length)*100 || 0).toFixed(1)}%</td>
                </tr>
            `).join('');

            // --- è¡¨ 4-6 ---
            const actionCounts = {};
            data.forEach(d => actionCounts[d.action] = (actionCounts[d.action] || 0) + 1);
            document.getElementById('table-4-6').innerHTML = Object.entries(actionCounts)
                .sort((a,b) => b[1] - a[1])
                .map(([key, val]) => `
                <tr>
                    <td class="table-cell font-medium">${key}</td>
                    <td class="table-cell text-center">${val}</td>
                    <td class="table-cell text-center font-mono">${((val/data.length)*100).toFixed(1)}%</td>
                </tr>
            `).join('');

            // --- è¡¨ 4-7 ---
            let linear = 0, loop = 0;
            uniqueCaseIds.forEach(id => {
                const pCount = data.filter(d => d.id === id).length;
                if (pCount > 3) loop++; else linear++;
            });
            document.getElementById('path-linear').innerText = linear;
            document.getElementById('path-loop').innerText = loop;
        }

        // åˆå§‹è¼‰å…¥é¡¯ç¤ºå…¨éƒ¨
        window.onload = () => {
            const data = JSON.parse(localStorage.getItem(KEY) || '[]');
            renderReports(data);
        };
    </script>
</body>
</html>