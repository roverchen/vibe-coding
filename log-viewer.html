<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç ”ç©¶æ•¸æ“šå ±è¡¨åˆ†æ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .report-card { background: white; border-radius: 1rem; padding: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .table-header { @apply bg-slate-100 text-slate-600 text-[11px] font-bold p-3 border-b; }
        .table-cell { @apply p-3 border-b text-sm text-slate-700; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        
        <div class="no-print space-y-4 mb-8">
            <div class="flex justify-between items-center">
                <button onclick="history.back()" class="text-indigo-600 font-bold hover:underline">â¬…ï¸ è¿”å›ç´€éŒ„ç«¯</button>
                <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-6 py-2 rounded-xl font-bold shadow-lg hover:bg-emerald-700 active:scale-95 transition-all flex items-center gap-2">
                    ğŸ“Š è¼¸å‡ºæˆ Excel (CSV)
                </button>
            </div>

            <div class="bg-indigo-600 p-6 rounded-2xl shadow-lg text-white">
                <h2 class="text-lg font-bold mb-4">ğŸ“… å ±è¡¨æ™‚é–“é€±æœŸç¯©é¸</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <button onclick="filterData('all')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">å…¨éƒ¨æ­·å²</button>
                    <button onclick="filterData('day')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">ä»Šæ—¥</button>
                    <button onclick="filterData('week')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">é€±å ±</button>
                    <button onclick="filterData('month')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">æœˆå ±</button>
                    <button onclick="filterData('year')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">å¹´å ±</button>
                </div>
                <p id="filter-status" class="mt-4 text-indigo-100 text-sm italic">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <div id="report-content">
            <h1 class="text-3xl font-black text-slate-800 mb-8 border-l-8 border-indigo-600 pl-4">è§€çœ¾è¡Œç‚ºç ”ç©¶åˆ†æå ±è¡¨</h1>

            <div class="report-card">
                <h3 class="font-black text-indigo-600 mb-4 text-lg border-b pb-2">è¡¨ 4-1ï¼šæˆå“¡çµ„åˆç´€éŒ„æ¬¡æ•¸è¡¨</h3>
                <table id="table-data-4-1" class="w-full text-left">
                    <thead>
                        <tr>
                            <th class="table-header">æˆå“¡çµ„åˆé¡å‹</th>
                            <th class="table-header text-center">å€‹æ¡ˆæ•¸ (n)</th>
                            <th class="table-header text-center">ç™¾åˆ†æ¯” (%)</th>
                        </tr>
                    </thead>
                    <tbody id="table-4-1"></tbody>
                </table>
            </div>

            <div class="report-card">
                <h3 class="font-black text-indigo-600 mb-4 text-lg border-b pb-2">è¡¨ 4-6ï¼šè§€çœ¾è¡Œç‚ºæ¬¡æ•¸çµ±è¨ˆ</h3>
                <table id="table-data-4-6" class="w-full text-left">
                    <thead>
                        <tr>
                            <th class="table-header">è¡Œç‚ºé …ç›®</th>
                            <th class="table-header text-center">ç¸½è¨ˆæ¬¡æ•¸</th>
                            <th class="table-header text-center">ä½”æ¯” (%)</th>
                        </tr>
                    </thead>
                    <tbody id="table-4-6"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const KEY = 'NMMBA_RESEARCH_FINAL';
        let currentFilteredData = []; // å„²å­˜ç•¶å‰ç¯©é¸éçš„æ•¸æ“šç”¨æ–¼è¼¸å‡º

        function filterData(period) {
            const rawData = JSON.parse(localStorage.getItem(KEY) || '[]');
            const now = new Date();
            let filtered = rawData;

            if (period !== 'all') {
                filtered = rawData.filter(d => {
                    const entryDate = new Date(d.time);
                    if (period === 'day') return entryDate.toDateString() === now.toDateString();
                    if (period === 'week') return (now - entryDate) <= 7*24*60*60*1000;
                    if (period === 'month') return (now - entryDate) <= 30*24*60*60*1000;
                    if (period === 'year') return entryDate.getFullYear() === now.getFullYear();
                    return true;
                });
            }
            currentFilteredData = filtered; // æ›´æ–°ç•¶å‰è¦–åœ–æ•¸æ“š
            document.getElementById('filter-status').innerText = `ç¯©é¸å®Œç•¢ï¼šå…± ${filtered.length} ç­†åŸå§‹é»ä½è³‡æ–™`;
            renderReports(filtered);
        }

        function renderReports(data) {
            const t41 = document.getElementById('table-4-1');
            const t46 = document.getElementById('table-4-6');
            
            if (data.length === 0) {
                t41.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-slate-400">ç„¡æ•¸æ“š</td></tr>';
                t46.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-slate-400">ç„¡æ•¸æ“š</td></tr>';
                return;
            }

            const groupCounts = {};
            const uniqueCaseIds = [...new Set(data.map(d => d.id))];
            uniqueCaseIds.forEach(id => {
                const firstEntry = data.find(d => d.id === id);
                const gName = firstEntry.group || "æœªåˆ†é¡";
                groupCounts[gName] = (groupCounts[gName] || 0) + 1;
            });

            t41.innerHTML = Object.entries(groupCounts).map(([key, val]) => `
                <tr>
                    <td class="table-cell font-bold">${key}</td>
                    <td class="table-cell text-center">${val}</td>
                    <td class="table-cell text-center font-mono">${((val/uniqueCaseIds.length)*100).toFixed(1)}%</td>
                </tr>
            `).join('');

            const actionCounts = {};
            data.forEach(d => actionCounts[d.action] = (actionCounts[d.action] || 0) + 1);
            t46.innerHTML = Object.entries(actionCounts).map(([key, val]) => `
                <tr>
                    <td class="table-cell font-medium">${key}</td>
                    <td class="table-cell text-center">${val}</td>
                    <td class="table-cell text-center font-mono">${((val/data.length)*100).toFixed(1)}%</td>
                </tr>
            `).join('');
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šå°‡å ±è¡¨è½‰æ›ä¸¦ä¸‹è¼‰ç‚º Excel/CSV ---
        function exportToExcel() {
            if (currentFilteredData.length === 0) {
                alert("ç›®å‰æ²’æœ‰æ•¸æ“šå¯ä»¥è¼¸å‡ºï¼");
                return;
            }

            let csvContent = "\ufeff"; // UTF-8 BOM ç¢ºä¿ Excel é–‹å•Ÿä¸äº‚ç¢¼
            
            // 1. è¼¸å‡ºåŸå§‹æµæ°´å¸³æ•¸æ“š
            csvContent += "åŸå§‹è§€æ¸¬ç´€éŒ„æ•¸æ“š\n";
            csvContent += "å€‹æ¡ˆç·¨è™Ÿ,æˆå“¡çµ„åˆ,è¡Œç‚ºé …ç›®,ä½ç½®åç¨±,æ‰€åœ¨é¤¨å€,æ™‚é–“\n";
            currentFilteredData.forEach(d => {
                const row = [d.id, d.group, d.action, d.locName || "ç„¡", d.map, d.time];
                csvContent += row.join(",") + "\n";
            });

            csvContent += "\n\n";

            // 2. è¼¸å‡ºçµ±è¨ˆæ‘˜è¦ (è¡¨ 4-1)
            csvContent += "è¡¨ 4-1 çµ±è¨ˆæ‘˜è¦ (æˆå“¡çµ„åˆ)\n";
            csvContent += "é¡å‹,æ•¸é‡,ç™¾åˆ†æ¯”\n";
            const rows41 = document.querySelectorAll("#table-4-1 tr");
            rows41.forEach(tr => {
                const cells = Array.from(tr.querySelectorAll('td')).map(td => td.innerText);
                csvContent += cells.join(",") + "\n";
            });

            // ä¸‹è¼‰æª”æ¡ˆ
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toLocaleDateString().replace(/\//g, "-");
            
            link.setAttribute("href", url);
            link.setAttribute("download", `æµ·ç”Ÿé¤¨ç ”ç©¶å ±è¡¨_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.onload = () => filterData('all');
    </script>
</body>
</html>