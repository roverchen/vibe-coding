<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”ç©¶ç´šï¼šæµ·ç”Ÿé¤¨è§€çœ¾è¡Œç‚ºèˆ‡å‹•ç·šè¨˜éŒ„ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map-container { 
            position: relative; 
            display: inline-block; 
            cursor: crosshair; 
            border: 2px solid #e2e8f0;
            background-color: #f8fafc;
            width: 100%; 
            overflow: hidden;
            border-radius: 8px;
        }
        .map-image { max-width: 100%; height: auto; display: none; }
        .map-image.active { display: block; }
        .marker {
            position: absolute;
            width: 24px;
            height: 24px;
            background-color: #4f46e5; 
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: bold;
            z-index: 20;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .path-line {
            position: absolute;
            height: 2px;
            background-color: #818cf8;
            z-index: 10;
            transform-origin: 0 50%;
            pointer-events: none;
            opacity: 0.5;
        }
        .sticky-panel { position: sticky; top: 1rem; max-height: calc(100vh - 2rem); overflow-y: auto; }
        .table-container { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-6">

    <div class="max-w-[1600px] mx-auto">
        <header class="mb-6 flex justify-between items-end border-b pb-4">
            <div>
                <h1 class="text-2xl font-extrabold text-slate-800">ğŸ“Š è§€çœ¾è¡Œç‚ºç ”ç©¶è¨˜éŒ„ç³»çµ±</h1>
                <p class="text-slate-500 text-sm">ä¾æ“šã€Šå…’ç«¥ç©ºé–“å®¶é•·è¡Œç‚ºç ”ç©¶ã€‹æ–¹æ³•è«–è¨­è¨ˆ</p>
            </div>
            <div class="space-x-2">
                <button onclick="exportToCSV()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition-all">
                    ğŸ“¥ å°å‡º CSV æ•¸æ“š
                </button>
                <button onclick="clearAllLogs()" class="bg-rose-100 text-rose-600 hover:bg-rose-200 px-4 py-2 rounded-lg text-sm font-bold transition-all">
                    ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•¸æ“š
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-4">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 sticky-panel space-y-6">
                    
                    <section>
                        <h2 class="text-md font-bold text-indigo-700 mb-3 flex items-center border-l-4 border-indigo-700 pl-2">
                            1. è§€å¯Ÿå€‹æ¡ˆè³‡è¨Š (Word p.57)
                        </h2>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 mb-1">è§€å¯Ÿç·¨è™Ÿ (Session ID)</label>
                                <input type="text" id="session-id" placeholder="ä¾‹å¦‚: 2023-A01" 
                                       class="w-full p-2 text-sm border rounded-md bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 mb-1">åœ˜é«”çµ„åˆ (Group Composition)</label>
                                <select id="group-type-select" class="w-full p-2 text-sm border rounded-md">
                                    <option value="1A1C">1æˆäºº + 1å…’ç«¥ (1A1C)</option>
                                    <option value="1A2C">1æˆäºº + 2å…’ç«¥ (1A2C)</option>
                                    <option value="2A1C">2æˆäºº + 1å…’ç«¥ (2A1C)</option>
                                    <option value="2A2C">2æˆäºº + 2å…’ç«¥ (2A2C)</option>
                                    <option value="å…¶ä»–">å…¶ä»–çµ„åˆ</option>
                                </select>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h2 class="text-md font-bold text-indigo-700 mb-3 flex items-center border-l-4 border-indigo-700 pl-2">
                            2. è¡Œç‚ºç´€éŒ„ (Word p.67-68)
                        </h2>
                        <div class="space-y-3">
                            <label class="block text-xs font-semibold text-slate-500 mb-1">è¡Œç‚ºä»£ç¢¼ (Behavioral Coding)</label>
                            <select id="action-select" class="w-full p-2 text-sm border rounded-md">
                                <optgroup label="äº’å‹•è¡Œç‚º (Interactive)">
                                    <option value="å…±åŒåƒèˆ‡">å…±åŒåƒèˆ‡ (Co-engagement)</option>
                                    <option value="å¼•å°èªªæ˜">å¼•å°èªªæ˜ (Instruction)</option>
                                    <option value="é«”åŠ›æ”¯æ´">é«”åŠ›æ”¯æ´ (Physical Support)</option>
                                    <option value="è¢«å‹•éš¨è¡Œ">è¢«å‹•éš¨è¡Œ (Passive following)</option>
                                </optgroup>
                                <optgroup label="éäº’å‹•è¡Œç‚º (Non-Interactive)">
                                    <option value="æ‹ç…§éŒ„å½±">æ‹ç…§éŒ„å½± (Photography)</option>
                                    <option value="è™•ç†ç§äº‹">è™•ç†ç§äº‹ (Private business)</option>
                                    <option value="ä¼‘æ¯ç­‰å¾…">ä¼‘æ¯ç­‰å¾… (Resting)</option>
                                </optgroup>
                            </select>
                        </div>
                    </section>

                    <section class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-indigo-800 text-xs uppercase tracking-wider">ç•¶å‰è¿½è¹¤ç‹€æ…‹</h3>
                            <span id="display-sequence" class="bg-indigo-200 text-indigo-800 text-[10px] px-2 py-0.5 rounded-full font-bold">SEQUENCE: 0</span>
                        </div>
                        <p class="text-[11px] text-indigo-600 mb-3">
                            <span class="opacity-70">æœ€å¾Œé»æ“Šä½ç½®ï¼š</span>
                            <span id="display-location" class="font-mono font-bold italic">æœªé¸æ“‡</span>
                        </p>
                        <button id="record-btn" onclick="recordPoint()" disabled
                                class="w-full bg-indigo-600 text-white font-bold py-3 rounded-md shadow-md disabled:bg-slate-300 disabled:shadow-none transition-all hover:bg-indigo-700 active:scale-95">
                            ç¢ºèªç´€éŒ„æ­¤ç¯€é»
                        </button>
                    </section>

                    <div class="pt-2">
                        <button onclick="finishSession()" class="w-full border border-slate-200 text-slate-500 text-sm font-bold py-2 rounded-md hover:bg-slate-50">
                            ğŸ çµæŸå€‹æ¡ˆ / æ¸…é™¤ç•«å¸ƒ
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <h2 class="text-lg font-bold text-slate-700">ğŸ—ºï¸ å¹³é¢åœ–é»æ“Šè¨˜éŒ„ (å‹•ç·šè¿½è¹¤)</h2>
                        <select id="map-select" class="p-2 border rounded-md text-xs bg-slate-50 outline-none">
                            <option value="map-image1" selected>å°ç£æ°´åŸŸé¤¨</option>
                            <option value="map-image2">çŠç‘šç‹åœ‹é¤¨</option>
                            <option value="map-image3">ä¸–ç•Œæ°´åŸŸé¤¨1,2F</option>
                            <option value="map-image4">ä¸–ç•Œæ°´åŸŸé¤¨3F</option>
                        </select>
                    </div>

                    <div id="map-container">
                        <img id="map-image1" class="map-image active" src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/f9f83808-8917-4d91-be95-98955736b763.jpg" alt="å°ç£æ°´åŸŸé¤¨">
                        <img id="map-image2" class="map-image" src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/aeee9399-5776-4dc9-bc34-74f3de9610ad.jpg" alt="çŠç‘šç‹åœ‹é¤¨">
                        <img id="map-image3" class="map-image" src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/be3ac2e6-4910-4308-9c19-d797081ea4e1.jpg" alt="ä¸–ç•Œæ°´åŸŸé¤¨1,2F">
                        <img id="map-image4" class="map-image" src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/c7e10c76-a9aa-49ea-abe4-81066e8fd518.jpg" alt="ä¸–ç•Œæ°´åŸŸé¤¨3F">
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-slate-50 px-4 py-3 border-b flex justify-between items-center">
                        <h3 class="text-sm font-bold text-slate-700">ğŸ“‹ å³æ™‚ç ”ç©¶æ—¥èªŒ (æœ€å¾Œ 50 ç­†)</h3>
                    </div>
                    <div class="table-container">
                        <table class="w-full text-left text-xs border-collapse">
                            <thead class="bg-slate-100 text-slate-600 sticky top-0">
                                <tr>
                                    <th class="p-3 border-b">æ™‚é–“</th>
                                    <th class="p-3 border-b">ç·¨è™Ÿ</th>
                                    <th class="p-3 border-b">çµ„åˆ</th>
                                    <th class="p-3 border-b">é †åº</th>
                                    <th class="p-3 border-b">è¡Œç‚ºå…§å®¹</th>
                                    <th class="p-3 border-b">åº§æ¨™(X,Y)</th>
                                    <th class="p-3 border-b">å€åŸŸ</th>
                                </tr>
                            </thead>
                            <tbody id="log-table-body" class="divide-y divide-slate-100">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const LOG_KEY = 'nmmba_research_v1';
        let currentPath = []; 
        let lastSelectedCoord = null;
        let logs = JSON.parse(localStorage.getItem(LOG_KEY) || '[]');

        const mapContainer = document.getElementById('map-container');
        const recordBtn = document.getElementById('record-btn');
        const displayLocation = document.getElementById('display-location');
        const displaySequence = document.getElementById('display-sequence');
        const logTableBody = document.getElementById('log-table-body');

        // åˆå§‹åŒ–
        updateLogTable();

        // 1. åœ°åœ–é»æ“Šé‚è¼¯
        mapContainer.addEventListener('click', (e) => {
            const rect = mapContainer.getBoundingClientRect();
            const x = Math.round(e.clientX - rect.left);
            const y = Math.round(e.clientY - rect.top);
            lastSelectedCoord = { x, y };
            displayLocation.textContent = `(${x}, ${y})`;
            renderVisuals();
            recordBtn.disabled = false;
        });

        // 2. è¨˜éŒ„åŠŸèƒ½ (å„ªåŒ– Log çµæ§‹)
        function recordPoint() {
            const sessionId = document.getElementById('session-id').value || 'TEMP-' + Date.now().toString().slice(-4);
            const groupType = document.getElementById('group-type-select').value;
            const action = document.getElementById('action-select').value;
            const mapName = document.getElementById('map-select').options[document.getElementById('map-select').selectedIndex].text;
            
            if (!lastSelectedCoord) return;

            const pointData = {
                timestamp: new Date().toLocaleString('zh-TW', {hour12: false}),
                sessionId: sessionId,
                groupType: groupType,
                sequence: currentPath.length + 1,
                action: action,
                x: lastSelectedCoord.x,
                y: lastSelectedCoord.y,
                map: mapName
            };

            currentPath.push(pointData);
            logs.unshift(pointData); // æ–°çš„åœ¨å‰é¢
            localStorage.setItem(LOG_KEY, JSON.stringify(logs));

            // æ›´æ–° UI
            displaySequence.textContent = `SEQUENCE: ${currentPath.length}`;
            lastSelectedCoord = null;
            recordBtn.disabled = true;
            renderVisuals();
            updateLogTable();
        }

        // 3. æ›´æ–°æ—¥èªŒè¡¨æ ¼
        function updateLogTable() {
            logTableBody.innerHTML = '';
            const displayLogs = logs.slice(0, 50); // åªé¡¯ç¤ºæœ€è¿‘ 50 ç­†
            
            displayLogs.forEach(log => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors";
                tr.innerHTML = `
                    <td class="p-3 text-slate-400">${log.timestamp.split(' ')[1]}</td>
                    <td class="p-3 font-bold text-indigo-600">${log.sessionId}</td>
                    <td class="p-3"><span class="bg-slate-100 px-2 py-0.5 rounded text-[10px]">${log.groupType}</span></td>
                    <td class="p-3 font-mono">#${log.sequence}</td>
                    <td class="p-3 font-semibold text-slate-700">${log.action}</td>
                    <td class="p-3 text-slate-500 italic">${log.x}, ${log.y}</td>
                    <td class="p-3 text-slate-500">${log.map}</td>
                `;
                logTableBody.appendChild(tr);
            });
        }

        // 4. CSV å°å‡º (ç¬¦åˆç ”ç©¶çµ±è¨ˆéœ€æ±‚)
        function exportToCSV() {
            if (logs.length === 0) return alert("å°šç„¡ç´€éŒ„å¯å°å‡º");
            
            let csvContent = "\uFEFF"; // UTF-8 BOM
            csvContent += "æ™‚é–“,è§€å¯Ÿç·¨è™Ÿ,åœ˜é«”çµ„åˆ,è»Œè·¡é †åº,è¡Œç‚ºå…§å®¹,åº§æ¨™X,åº§æ¨™Y,å€åŸŸ\n";
            
            logs.forEach(log => {
                csvContent += `${log.timestamp},${log.sessionId},${log.groupType},${log.sequence},${log.action},${log.x},${log.y},${log.map}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `è§€çœ¾è¡Œç‚ºç ”ç©¶æ•¸æ“š_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 5. è¦–è¦ºåŒ–è¼”åŠ© (å‹•ç·šç¹ªè£½)
        function renderVisuals() {
            mapContainer.querySelectorAll('.marker, .path-line, .temp-marker').forEach(el => el.remove());
            for (let i = 0; i < currentPath.length - 1; i++) {
                drawLine(currentPath[i].x, currentPath[i].y, currentPath[i+1].x, currentPath[i+1].y);
            }
            currentPath.forEach((p) => {
                const marker = document.createElement('div');
                marker.className = 'marker';
                marker.style.left = p.x + 'px'; marker.style.top = p.y + 'px';
                marker.textContent = p.sequence;
                mapContainer.appendChild(marker);
            });
            if (lastSelectedCoord) {
                const temp = document.createElement('div');
                temp.className = 'marker temp-marker';
                temp.style.left = lastSelectedCoord.x + 'px'; temp.style.top = lastSelectedCoord.y + 'px';
                temp.style.backgroundColor = '#ef4444'; temp.textContent = '+';
                mapContainer.appendChild(temp);
            }
        }

        function drawLine(x1, y1, x2, y2) {
            const line = document.createElement('div');
            line.className = 'path-line';
            const dist = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
            const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
            line.style.width = dist + 'px'; line.style.left = x1 + 'px'; line.style.top = y1 + 'px';
            line.style.transform = `rotate(${angle}deg)`;
            mapContainer.appendChild(line);
        }

        function finishSession() {
            if (confirm("çµæŸæ­¤çµ„è§€å¯Ÿï¼Ÿ(å°‡æ¸…é™¤åœ°åœ–ä¸Šçš„è·¯å¾‘ï¼Œä½†æ•¸æ“šå·²å„²å­˜æ–¼ Log)")) {
                currentPath = [];
                lastSelectedCoord = null;
                displayLocation.textContent = 'æœªé¸æ“‡';
                displaySequence.textContent = 'SEQUENCE: 0';
                renderVisuals();
            }
        }

        function clearAllLogs() {
            if (confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡åˆªé™¤æœ¬åœ°ç«¯ã€Œæ‰€æœ‰ã€æ­·å²ç ”ç©¶æ•¸æ“šï¼Œç¢ºå®šå—ï¼Ÿ")) {
                logs = [];
                localStorage.removeItem(LOG_KEY);
                updateLogTable();
                finishSession();
            }
        }

        document.getElementById('map-select').addEventListener('change', (e) => {
            document.querySelectorAll('.map-image').forEach(img => img.classList.remove('active'));
            document.getElementById(e.target.value).classList.add('active');
            currentPath = [];
            renderVisuals();
        });
    </script>
</body>
</html>