<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç ”ç©¶æ•¸æ“šå ±è¡¨ç³»çµ± - ä¿®æ­£ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .report-card { background: white; border-radius: 1rem; padding: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .table-header { @apply bg-slate-100 text-slate-600 text-[11px] font-bold uppercase p-3 border-b; }
        .table-cell { @apply p-3 border-b text-sm text-slate-700; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        
        <div class="no-print space-y-4 mb-8">
            <div class="flex justify-between items-center">
                <button onclick="history.back()" class="text-indigo-600 font-bold flex items-center gap-1 hover:underline">
                    â¬…ï¸ è¿”å›ç´€éŒ„
                </button>
                <div class="flex gap-2">
                    <button onclick="window.print()" class="bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-bold">åˆ—å°å ±è¡¨</button>
                </div>
            </div>

            <div class="bg-indigo-600 p-6 rounded-2xl shadow-lg text-white">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">ğŸ“… å ±è¡¨æ™‚é–“é€±æœŸç¯©é¸</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <button onclick="filterData('all')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 transition-all font-bold">å…¨éƒ¨æ­·å²</button>
                    <button onclick="filterData('day')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 transition-all font-bold">æ—¥å ± (ä»Šæ—¥)</button>
                    <button onclick="filterData('week')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 transition-all font-bold">é€±å ± (7æ—¥)</button>
                    <button onclick="filterData('month')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 transition-all font-bold">æœˆå ± (30æ—¥)</button>
                    <button onclick="filterData('year')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 transition-all font-bold">å¹´å ± (ä»Šå¹´)</button>
                </div>
                <p id="filter-status" class="mt-4 text-indigo-100 text-sm italic font-medium">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <div id="report-content">
            <h1 id="report-title" class="text-3xl font-black text-slate-800 mb-8 border-l-8 border-indigo-600 pl-4">è§€çœ¾è¡Œç‚ºç ”ç©¶åˆ†æå ±è¡¨</h1>

            <div class="report-card">
                <h3 class="font-black text-indigo-600 mb-4 text-lg border-b pb-2">è¡¨ 4-1ï¼šæˆå“¡çµ„åˆç´€éŒ„æ¬¡æ•¸è¡¨ (ä¾å€‹æ¡ˆè¨ˆ)</h3>
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr>
                            <th class="table-header">æˆå“¡çµ„åˆé¡å‹</th>
                            <th class="table-header text-center">å€‹æ¡ˆæ•¸ (n)</th>
                            <th class="table-header text-center">ç™¾åˆ†æ¯” (%)</th>
                        </tr>
                    </thead>
                    <tbody id="table-4-1"></tbody>
                </table>
            </div>

            <div class="report-card">
                <h3 class="font-black text-indigo-600 mb-4 text-lg border-b pb-2">è¡¨ 4-6ï¼šè§€çœ¾è¡Œç‚ºæ¬¡æ•¸çµ±è¨ˆ (ä¾ç¸½è¡Œç‚ºè¨ˆ)</h3>
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr>
                            <th class="table-header">è¡Œç‚ºé …ç›®</th>
                            <th class="table-header text-center">ç¸½è¨ˆæ¬¡æ•¸</th>
                            <th class="table-header text-center">ä½”æ¯” (%)</th>
                        </tr>
                    </thead>
                    <tbody id="table-4-6"></tbody>
                </table>
            </div>

            <div class="report-card">
                <h3 class="font-black text-indigo-600 mb-4 text-lg border-b pb-2">è¡¨ 4-7ï¼šé«”é©—å‹•ç·šé¡å‹åˆ†å¸ƒ</h3>
                <table class="w-full text-left">
                    <thead>
                        <tr>
                            <th class="table-header">å‹•ç·šé¡å‹</th>
                            <th class="table-header text-center">å€‹æ¡ˆæ•¸</th>
                            <th class="table-header">åˆæ­¥ç‰¹å¾µæè¿°</th>
                        </tr>
                    </thead>
                    <tbody id="table-4-7">
                        <tr><td class="table-cell font-bold">ç›´è¡Œ (Linear)</td><td class="table-cell text-center font-bold" id="path-linear">0</td><td class="table-cell text-xs text-slate-400">è§€å¯Ÿé»å°‘æ–¼ 3 å€‹ï¼Œè·¯å¾‘ç°¡å–®ç›´è¦ºã€‚</td></tr>
                        <tr><td class="table-cell font-bold">ç’°ç‹€ (Loop)</td><td class="table-cell text-center font-bold" id="path-loop">0</td><td class="table-cell text-xs text-slate-400">è§€å¯Ÿé»é” 4 å€‹ä»¥ä¸Šï¼Œå…·å‚™æ¢ç´¢æˆ–å›æµç‰¹å¾µã€‚</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const KEY = 'NMMBA_RESEARCH_FINAL';

        // è¼”åŠ©å‡½å¼ï¼šç¢ºä¿æ—¥æœŸè§£ææ­£ç¢º
        function parseEntryDate(timeStr) {
            // å„ªå…ˆå˜—è©¦ ISO æ ¼å¼ (2025-12-20T10:00:00)
            let d = new Date(timeStr);
            if (!isNaN(d.getTime())) return d;
            
            // å¦‚æœåªæœ‰æ™‚åˆ†ç§’ (10:00:00)ï¼Œè£œä¸Šä»Šæ—¥æ—¥æœŸ
            const now = new Date();
            const parts = timeStr.split(':');
            if (parts.length >= 2) {
                now.setHours(parseInt(parts[0]), parseInt(parts[1]), parts[2] ? parseInt(parts[2]) : 0);
                return now;
            }
            return new Date();
        }

        function filterData(period) {
            const rawData = JSON.parse(localStorage.getItem(KEY) || '[]');
            const now = new Date();
            let filtered = [];
            let periodText = "";

            if (period === 'all') {
                filtered = rawData;
                periodText = "æ‰€æœ‰æ­·å²æ•¸æ“š";
            } else {
                filtered = rawData.filter(d => {
                    const entryDate = parseEntryDate(d.time);
                    if (period === 'day') {
                        periodText = "ä»Šæ—¥å ±è¡¨";
                        return entryDate.toDateString() === now.toDateString();
                    } else if (period === 'week') {
                        periodText = "é€±å ± (è¿‘ 7 æ—¥)";
                        return (now - entryDate) <= (7 * 24 * 60 * 60 * 1000);
                    } else if (period === 'month') {
                        periodText = "æœˆå ± (è¿‘ 30 æ—¥)";
                        return (now - entryDate) <= (30 * 24 * 60 * 60 * 1000);
                    } else if (period === 'year') {
                        periodText = "å¹´å ± (ä»Šå¹´)";
                        return entryDate.getFullYear() === now.getFullYear();
                    }
                });
            }

            document.getElementById('filter-status').innerText = `æ­£åœ¨é¡¯ç¤ºï¼š${periodText} (${filtered.length} ç­†è³‡æ–™)`;
            document.getElementById('report-title').innerText = `è§€çœ¾è¡Œç‚ºç ”ç©¶åˆ†æ - ${periodText}`;
            renderReports(filtered);
        }

        function renderReports(data) {
            const t41 = document.getElementById('table-4-1');
            const t46 = document.getElementById('table-4-6');
            
            if (data.length === 0) {
                t41.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-slate-400 italic">è©²å€æ®µç„¡æ•¸æ“š</td></tr>';
                t46.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-slate-400 italic">è©²å€æ®µç„¡æ•¸æ“š</td></tr>';
                document.getElementById('path-linear').innerText = 0;
                document.getElementById('path-loop').innerText = 0;
                return;
            }

            // --- è¡¨ 4-1ï¼šä»¥å€‹æ¡ˆç‚ºå–®ä½çµ±è¨ˆçµ„åˆ ---
            const groupCounts = {};
            const uniqueCaseIds = [...new Set(data.map(d => d.id))];
            
            uniqueCaseIds.forEach(id => {
                const caseData = data.find(d => d.id === id);
                const gName = caseData.group || "æœªåˆ†é¡";
                groupCounts[gName] = (groupCounts[gName] || 0) + 1;
            });

            t41.innerHTML = Object.entries(groupCounts)
                .sort((a,b) => b[1] - a[1]) // æ•¸é‡å¤šæ’å‰é¢
                .map(([key, val]) => `
                <tr>
                    <td class="table-cell font-bold text-indigo-900">${key}</td>
                    <td class="table-cell text-center">${val}</td>
                    <td class="table-cell text-center font-mono font-bold text-indigo-600">${((val/uniqueCaseIds.length)*100).toFixed(1)}%</td>
                </tr>
            `).join('');

            // --- è¡¨ 4-6ï¼šä»¥æ‰€æœ‰è¡Œç‚ºé»ä½çµ±è¨ˆ ---
            const actionCounts = {};
            data.forEach(d => {
                actionCounts[d.action] = (actionCounts[d.action] || 0) + 1;
            });

            t46.innerHTML = Object.entries(actionCounts)
                .sort((a,b) => b[1] - a[1])
                .map(([key, val]) => `
                <tr>
                    <td class="table-cell font-medium">${key}</td>
                    <td class="table-cell text-center">${val}</td>
                    <td class="table-cell text-center font-mono font-bold text-emerald-600">${((val/data.length)*100).toFixed(1)}%</td>
                </tr>
            `).join('');

            // --- è¡¨ 4-7ï¼šå‹•ç·š ---
            let linear = 0, loop = 0;
            uniqueCaseIds.forEach(id => {
                const count = data.filter(d => d.id === id).length;
                if (count >= 4) loop++; else linear++;
            });
            document.getElementById('path-linear').innerText = linear;
            document.getElementById('path-loop').innerText = loop;
        }

        window.onload = () => filterData('all');
    </script>
</body>
</html>