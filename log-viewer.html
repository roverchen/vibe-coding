<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分析端：數據瀏覽器</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 p-6">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <header class="bg-slate-800 p-6 text-white flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold">📋 研究數據總覽</h1>
                    <p class="text-slate-400 text-xs">讀取自本地存儲空間 (localStorage)</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="exportCSV()" class="bg-emerald-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700">📥 導出 CSV</button>
                    <button onclick="clearData()" class="bg-rose-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-rose-700">🗑️ 全部清除</button>
                </div>
            </header>

            <div class="p-4 border-b bg-slate-50 flex gap-4">
                <input type="text" id="filter-id" oninput="renderTable()" placeholder="篩選編號..." class="p-2 border rounded-md text-sm w-48">
                <div id="stats" class="text-sm self-center text-slate-500 font-medium"></div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-100 text-slate-600 uppercase text-xs">
                        <tr>
                            <th class="p-4">時間</th><th class="p-4">觀察編號</th><th class="p-4">組合</th>
                            <th class="p-4">序號</th><th class="p-4">行為代碼</th><th class="p-4">座標</th><th class="p-4">區域</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100 text-slate-700">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const LOG_KEY = 'nmmba_research_v1';
        let logs = [];

        function loadLogs() {
            logs = JSON.parse(localStorage.getItem(LOG_KEY) || '[]');
            renderTable();
        }

        function renderTable() {
            const filter = document.getElementById('filter-id').value.toLowerCase();
            const body = document.getElementById('table-body');
            body.innerHTML = '';
            
            const filtered = logs.filter(l => l.sessionId.toLowerCase().includes(filter));
            document.getElementById('stats').textContent = `共 ${filtered.length} 筆記錄`;

            filtered.forEach(log => {
                const row = `
                    <tr class="hover:bg-indigo-50 transition-colors">
                        <td class="p-4 text-slate-400 font-mono text-[11px]">${log.timestamp}</td>
                        <td class="p-4 font-bold text-indigo-700">${log.sessionId}</td>
                        <td class="p-4"><span class="bg-slate-100 px-2 py-1 rounded text-[10px]">${log.groupType}</span></td>
                        <td class="p-4 font-mono">#${log.sequence}</td>
                        <td class="p-4 font-semibold">${log.action}</td>
                        <td class="p-4 text-slate-400 font-mono italic">${log.x}, ${log.y}</td>
                        <td class="p-4 text-slate-500">${log.map}</td>
                    </tr>
                `;
                body.insertAdjacentHTML('beforeend', row);
            });
        }

        function exportCSV() {
            if (logs.length === 0) return alert("無數據");
            let csv = "\uFEFF時間,觀察編號,組合,序號,行為,X,Y,地圖\n";
            logs.forEach(l => csv += `${l.timestamp},${l.sessionId},${l.groupType},${l.sequence},${l.action},${l.x},${l.y},${l.map}\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `海生館研究數據_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        function clearData() {
            if (confirm("⚠️ 警告：這將永久刪除本地端「所有」數據！")) {
                localStorage.removeItem(LOG_KEY);
                loadLogs();
            }
        }

        // 監聽數據變化 (當在 recorder.html 新增時，此頁面若開著會自動更新)
        window.addEventListener('storage', (e) => {
            if (e.key === LOG_KEY) loadLogs();
        });

        window.onload = loadLogs;
    </script>
</body>
</html>