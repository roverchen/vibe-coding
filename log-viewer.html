<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æµ·ç”Ÿé¤¨ç ”ç©¶æ•¸æ“šå®Œæ•´å ±è¡¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .report-card { background: white; border-radius: 1rem; padding: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .table-header { @apply bg-slate-100 text-slate-600 text-[11px] font-bold p-3 border-b; }
        .table-cell { @apply p-3 border-b text-sm text-slate-700; }
        .stat-val { @apply text-2xl font-black text-indigo-600; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        
        <div class="no-print space-y-4 mb-8">
            <div class="flex justify-between items-center">
                <button onclick="history.back()" class="text-indigo-600 font-bold hover:underline">â¬…ï¸ è¿”å›ç´€éŒ„ç«¯</button>
                <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-emerald-700 active:scale-95 transition-all flex items-center gap-2">
                    ğŸ“Š è¼¸å‡ºå®Œæ•´ Excel å ±è¡¨ (CSV)
                </button>
            </div>

            <div class="bg-indigo-600 p-6 rounded-2xl shadow-lg text-white">
                <h2 class="text-lg font-bold mb-4">ğŸ“… å ±è¡¨æ™‚é–“é€±æœŸç¯©é¸</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <button onclick="filterData('all')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">å…¨éƒ¨æ­·å²</button>
                    <button onclick="filterData('day')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">ä»Šæ—¥</button>
                    <button onclick="filterData('week')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">é€±å ±</button>
                    <button onclick="filterData('month')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">æœˆå ±</button>
                    <button onclick="filterData('year')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">å¹´å ±</button>
                </div>
                <p id="filter-status" class="mt-4 text-indigo-100 text-sm italic italic">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <div id="report-content">
            <h1 class="text-3xl font-black text-slate-800 mb-8 border-l-8 border-indigo-600 pl-4">è§€çœ¾è¡Œç‚ºç ”ç©¶åˆ†æå®Œæ•´å ±è¡¨</h1>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="report-card">
                    <h3 class="font-black text-indigo-600 mb-4 border-b pb-2">è¡¨ 4-1ï¼šæˆå“¡çµ„åˆçµ±è¨ˆ</h3>
                    <table class="w-full text-left"><tbody id="table-4-1"></tbody></table>
                </div>
                <div class="report-card">
                    <h3 class="font-black text-indigo-600 mb-4 border-b pb-2">è¡¨ 4-2ï¼šå¹³å‡åœç•™æ™‚é–“ (ç§’)</h3>
                    <div class="flex justify-around items-center h-24">
                        <div class="text-center"><p class="text-xs text-slate-400 font-bold">ç¸½å¹³å‡</p><div id="avg-time" class="stat-val">0</div></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="report-card">
                    <h3 class="font-black text-indigo-600 mb-4 border-b pb-2">è¡¨ 4-6ï¼šè§€çœ¾è¡Œç‚ºæ¬¡æ•¸çµ±è¨ˆ</h3>
                    <table class="w-full text-left"><tbody id="table-4-6"></tbody></table>
                </div>
                <div class="report-card">
                    <h3 class="font-black text-indigo-600 mb-4 border-b pb-2">è¡¨ 4-7ï¼šå‹•ç·šæ¨¡å¼é¡å‹åˆ†æ</h3>
                    <div class="flex justify-around py-4">
                        <div class="text-center"><p class="text-xs text-slate-400 font-bold">ç›´ç·šå‹</p><div id="path-linear" class="stat-val text-emerald-500">0</div></div>
                        <div class="text-center"><p class="text-xs text-slate-400 font-bold">è¿´è·¯å‹</p><div id="path-loop" class="stat-val text-amber-500">0</div></div>
                    </div>
                </div>
            </div>

            <div class="report-card overflow-x-auto">
                <h3 class="font-black text-indigo-600 mb-4 border-b pb-2">åŸå§‹ç´€éŒ„æµæ°´å¸³ (åŒ¯å‡ºå°‡åŒ…å«å®Œæ•´æ˜ç´°)</h3>
                <table class="w-full text-left text-xs">
                    <thead><tr class="bg-slate-50"><th class="p-2">ç·¨è™Ÿ</th><th class="p-2">çµ„åˆ</th><th class="p-2">è¡Œç‚º</th><th class="p-2">ä½ç½®åç¨±</th><th class="p-2">æ™‚é–“</th></tr></thead>
                    <tbody id="raw-data-preview"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const KEY = 'NMMBA_RESEARCH_FINAL';
        let currentFilteredData = [];

        function filterData(period) {
            const rawData = JSON.parse(localStorage.getItem(KEY) || '[]');
            const now = new Date();
            let filtered = rawData;
            if (period !== 'all') {
                filtered = rawData.filter(d => {
                    const entryDate = new Date(d.time);
                    if (period === 'day') return entryDate.toDateString() === now.toDateString();
                    if (period === 'week') return (now - entryDate) <= 7*24*60*60*1000;
                    if (period === 'month') return (now - entryDate) <= 30*24*60*60*1000;
                    if (period === 'year') return entryDate.getFullYear() === now.getFullYear();
                    return true;
                });
            }
            currentFilteredData = filtered;
            document.getElementById('filter-status').innerText = `ç›®å‰é¡¯ç¤ºç­†æ•¸ï¼š${filtered.length}`;
            renderReports(filtered);
        }

        function renderReports(data) {
            const uniqueIds = [...new Set(data.map(d => d.id))];
            
            // 4-1 æˆå“¡çµ„åˆ (å»é‡)
            const gCounts = {};
            uniqueIds.forEach(id => {
                const g = data.find(d => d.id === id).group;
                gCounts[g] = (gCounts[g] || 0) + 1;
            });
            document.getElementById('table-4-1').innerHTML = Object.entries(gCounts).map(([k, v]) => 
                `<tr><td class="table-cell font-bold">${k}</td><td class="table-cell text-right">${v} çµ„</td></tr>`).join('');

            // 4-2 åœç•™æ™‚é–“ (ç°¡åŒ–è¨ˆç®—ï¼šæ¯å€‹å€‹æ¡ˆæœ€å¾Œé»ä½ - æœ€åˆé»ä½)
            let totalSecs = 0;
            uniqueIds.forEach(id => {
                const times = data.filter(d => d.id === id).map(d => new Date(d.time));
                if (times.length > 1) totalSecs += (Math.max(...times) - Math.min(...times)) / 1000;
            });
            document.getElementById('avg-time').innerText = uniqueIds.length ? Math.round(totalSecs / uniqueIds.length) : 0;

            // 4-6 è¡Œç‚ºçµ±è¨ˆ
            const aCounts = {};
            data.forEach(d => aCounts[d.action] = (aCounts[d.action] || 0) + 1);
            document.getElementById('table-4-6').innerHTML = Object.entries(aCounts).map(([k, v]) => 
                `<tr><td class="table-cell">${k}</td><td class="table-cell text-right font-mono">${v} æ¬¡</td></tr>`).join('');

            // 4-7 å‹•ç·šåˆ†æ (å®šç¾©ï¼šé»ä½æ•¸ > 3 ç‚ºè¿´è·¯)
            let linear = 0, loop = 0;
            uniqueIds.forEach(id => { if (data.filter(d => d.id === id).length > 3) loop++; else linear++; });
            document.getElementById('path-linear').innerText = linear;
            document.getElementById('path-loop').innerText = loop;

            // æµæ°´å¸³é è¦½ (å–å‰10ç­†)
            document.getElementById('raw-data-preview').innerHTML = data.slice(0, 10).map(d => 
                `<tr class="border-b"><td class="p-2">${d.id}</td><td class="p-2">${d.group}</td><td class="p-2">${d.action}</td><td class="p-2">${d.locName || '-'}</td><td class="p-2 text-[10px]">${new Date(d.time).toLocaleTimeString()}</td></tr>`).join('');
        }

        function exportToExcel() {
            if (!currentFilteredData.length) return alert("ç„¡æ•¸æ“š");
            let csv = "\ufeffå€‹æ¡ˆç·¨è™Ÿ,æˆå“¡çµ„åˆ,è¡Œç‚ºé …ç›®,ä½ç½®åç¨±,æ‰€åœ¨é¤¨å€,åº§æ¨™X,åº§æ¨™Y,æ™‚é–“\n";
            currentFilteredData.forEach(d => {
                csv += `${d.id},${d.group},${d.action},${d.locName || ""},${d.map},${d.x},${d.y},${d.time}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `æµ·ç”Ÿé¤¨ç ”ç©¶å®Œæ•´æ•¸æ“š_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        window.onload = () => filterData('all');
    </script>
</body>
</html>