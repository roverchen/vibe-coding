<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>WiFi 組態設定 - BLE 傳輸</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 確保全螢幕高度和柔軟的背景色 */
    body { 
        background-color: #1f2937; 
        color: #f9fafb; 
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        display: flex; 
        justify-content: center; 
        align-items: center; 
        min-height: 100vh; 
        margin: 0; 
        padding: 1rem;
    }
    .container-wrap { 
        max-width: 450px; 
        width: 100%; 
        padding: 30px; 
        background-color: #1f2937;
        border-radius: 1.5rem;
    }
    
    /* 頂部控制列 - 模仿搖桿頁面佈局 */
    .top-control{
        width:100%;
        display:flex;
        gap:8px;
        align-items:center;
        margin-bottom: 20px;
    }

    /* 按鈕樣式 (Connect / Send) */
    button {
        padding:12px 16px;
        border-radius:12px;
        border:none;
        background:#4f46e5; /* 靛藍色 */
        color:white;
        font-weight:700;
        /* Neumorphic 外凸效果 */
        box-shadow: 3px 3px 6px #171d26, -3px -3px 6px #273142; 
        transition: all 0.15s ease-in-out;
    }
    button:hover { 
        background: #3730a3; 
        box-shadow: 5px 5px 10px #171d26, -5px -5px 10px #273142;
    }
    button:disabled {
        background: #374151;
        color: #9ca3af;
        box-shadow: none;
        cursor: not-allowed;
    }
    
    /* 狀態顯示區域 - 內凹樣式 */
    #statusLog{
        flex:1;
        text-align:center;
        font-weight:600;
        font-size: 0.875rem;
        color:#9ca3af; 
        padding: 12px; 
        background: #2d3748; 
        border-radius: 12px; 
        /* Neumorphic 內凹效果 */
        box-shadow: inset 3px 3px 6px #171d26, inset -3px -3px 6px #3b4555;
    }
    .log-success { color: #4ade80 !important; }
    .log-error { color: #f87171 !important; }
    .log-info { color: #60a5fa !important; }

    /* 輸入框樣式 */
    input[type="text"], input[type="password"] {
        width: 100%;
        padding: 12px;
        margin-top: 4px;
        border-radius: 10px;
        border: none;
        background: #2d3748; 
        color: #f9fafb;
        font-weight: 500;
        /* 深色內凹效果 */
        box-shadow: inset 3px 3px 6px #171d26, inset -3px -3px 6px #3b4555;
        transition: box-shadow 0.15s;
    }

    input[type="text"]:focus, input[type="password"]:focus {
        outline: none;
        background: #232d3a;
        /* 輕微的亮光效果 */
        box-shadow: inset 2px 2px 4px #171d26, inset -2px -2px 4px #3b4555, 0 0 5px #4f46e5;
    }
    
    /* 返回主選單按鈕 */
    .menu-button {
        display: block;
        width: 100%;
        padding: 12px;
        border-radius: 12px;
        border: none;
        background: #4f46e5; 
        color: white;
        font-weight: 700;
        text-align: center;
        text-decoration: none;
        box-shadow: 3px 3px 6px #171d26, -3px -3px 6px #273142;
        transition: all 0.2s ease;
    }
  </style>
</head>
<body class="p-4">
    <div class="container-wrap">
        
        <h1 class="text-2xl font-extrabold text-center text-indigo-400 mb-6 border-b border-gray-700 pb-2">
            WiFi 組態設定
        </h1>
        
        <!-- 頂部控制列：連線按鈕與狀態 -->
        <div class="top-control">
            <button id="btnConnect" class="flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <span>連線 BLE</span>
            </button>
            
            <div id="statusLog">
                等待連線...
            </div>
        </div>

        <!-- 設定表單 -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl space-y-4">
            <div class="space-y-2">
                <label for="ssid" class="block text-sm font-medium text-gray-400">Wi-Fi 網路名稱 (SSID)</label>
                <input type="text" id="ssid" placeholder="請輸入 SSID" required>
            </div>
            
            <div class="space-y-2">
                <label for="password" class="block text-sm font-medium text-gray-400">密碼 (Password)</label>
                <input type="password" id="password" placeholder="請輸入密碼" required>
            </div>
            
            <button id="btnSend" class="mt-6 w-full bg-indigo-600 text-white p-4 rounded-xl font-bold transition duration-150 hover:bg-indigo-700 disabled:opacity-50" disabled>
                傳送設定至裝置
            </button>
            
            <p class="text-center text-xs text-gray-500 pt-2">
                傳輸格式：SSID|密碼 (例如: "MyWifi|12345678")
            </p>
        </div>
        
        <!-- 返回主選單按鈕 -->
        <a href="index.html" class="menu-button w-full mt-8 text-center bg-gray-700 hover:bg-gray-600 text-gray-300 p-3 block rounded-xl shadow-md transition">
            返回主選單
        </a>
    </div>

<script>
// --- BLE Configuration ---
const SERVICE_UUID = '0000ffff-0000-1000-8000-000000000000'; 
const SSID_CHARACTERISTIC_UUID = '0000ffff-0000-1000-8000-000000000001'; 
const PASS_CHARACTERISTIC_UUID = '0000ffff-0000-1000-8000-000000000002'; 
const DEVICE_ID_KEY = 'ble_config_device_id'; 

// --- State Variables ---
let device = null;
let ssid_characteristic = null;
let pass_characteristic = null;

// --- DOM Elements ---
const statusLog = document.getElementById('statusLog');
const btnConnect = document.getElementById('btnConnect');
const btnSend = document.getElementById('btnSend');
const ssidInput = document.getElementById('ssid');
const passwordInput = document.getElementById('password');


// --- Helper Functions ---

/**
 * 將訊息記錄到狀態區域
 */
function logStatus(message, type = 'info') {
    let typeClass = '';
    switch (type) {
        case 'success':
            typeClass = 'log-success';
            break;
        case 'error':
            typeClass = 'log-error';
            break;
        case 'info':
        default:
            typeClass = 'log-info';
            break;
    }
    statusLog.classList.remove('log-success', 'log-error', 'log-info');
    statusLog.classList.add(typeClass);
    statusLog.innerHTML = message;
}

/**
 * 更新 UI 狀態（按鈕啟用/禁用）
 */
function updateUI(isConnected) {
    if (isConnected) {
        btnConnect.querySelector('span').textContent = '斷開';
        btnSend.disabled = false;
    } else {
        btnConnect.querySelector('span').textContent = '連線 BLE';
        btnSend.disabled = true;
    }
}


// --- BLE Connection Logic ---

/**
 * 處理 BLE 斷線
 */
function onDisconnect() {
    logStatus('❌ 已斷線', 'error');
    updateUI(false);
    if (device) device.removeEventListener('gattserverdisconnected', onDisconnect);
    device = null;
    ssid_characteristic = null;
    pass_characteristic = null;
}

/**
 * 取得裝置物件 (透過掃描)
 */
async function acquireDevice() {
    logStatus('掃描中 (過濾: esp32)...', 'info');
    
    try {
        // 使用 filters 確保只顯示預期的裝置
        const newDevice = await navigator.bluetooth.requestDevice({
            filters:[{ namePrefix: 'esp32' }],
            optionalServices: [SERVICE_UUID] 
        });
        
        localStorage.setItem(DEVICE_ID_KEY, newDevice.id);
        return newDevice;
    } catch(e) {
        if (e.name === 'NotFoundError') {
             throw new Error("找不到裝置或使用者取消。");
        }
        throw e;
    }
}


/**
 * 連線/斷開 BLE 裝置
 */
async function connectBLE(){
    if (!navigator.bluetooth) {
        logStatus('❌ 瀏覽器不支援 Web Bluetooth。', 'error');
        return;
    }
    
    // 處理已連線狀態下的按鈕點擊 (斷開連線)
    if (device && device.gatt.connected) {
        logStatus('中斷連線中...');
        device.gatt.disconnect();
        // onDisconnect 會處理 UI 狀態更新
        return;
    }

    try{
        device = await acquireDevice();
        if (!device) throw new Error("裝置未連線或未找到。");

        logStatus(`連線到 ${device.name}...`, 'info');

        device.removeEventListener('gattserverdisconnected', onDisconnect);
        device.addEventListener('gattserverdisconnected', onDisconnect);

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        ssid_characteristic = await service.getCharacteristic(SSID_CHARACTERISTIC_UUID); 
        pass_characteristic = await service.getCharacteristic(PASS_CHARACTERISTIC_UUID); 
        
        logStatus('✅ 已連線: ' + device.name, 'success');
        updateUI(true);

    }catch(err){
        console.error('BLE 連線失敗:', err);
        logStatus(`❌ 連線失敗 (${err.message.slice(0, 30)}...)`, 'error');
        updateUI(false);
        if (device && (!device.gatt || !device.gatt.connected)) {
            device = null;
        }
    }
}


/**
 * 傳送 SSID 和密碼給裝置
 */
async function sendConfig(){
    if(!ssid_characteristic || !pass_characteristic || !device || !device.gatt.connected) {
        logStatus('⚠️ 請先連線到 BLE 裝置。', 'info');
        return;
    }
    
    const ssid = ssidInput.value.trim();
    const password = passwordInput.value.trim();

    if (ssid === "" || password === "") {
        logStatus('⚠️ SSID 和密碼欄位不可為空。', 'error');
        return;
    }

    // 建立 payload 格式: SSID|密碼 (例如: "MyWifi|12345678")
    const payload = `${ssid}|${password}`;
    
    try{
        logStatus(`傳送設定: ${ssid} | ${password.length} 字元...`, 'info');
        btnSend.disabled = true; // 傳送中禁用按鈕

        //await characteristic.writeValue(new TextEncoder().encode(payload));
        await ssid_characteristic.writeValue(new TextEncoder().encode(ssid));
        await pass_characteristic.writeValue(new TextEncoder().encode(password));
        
        logStatus('✅ 設定成功傳送! 裝置應開始嘗試連線 Wi-Fi。', 'success');
        
    }catch(err){
        logStatus(`❌ 傳送失敗: ${err.message.slice(0, 50)}...`, 'error');
        console.error('BLE Write Error:', err);
    } finally {
        btnSend.disabled = false;
    }
}

// --- Initialization ---

btnConnect.addEventListener('click', connectBLE);
btnSend.addEventListener('click', sendConfig);
// 檢查瀏覽器是否支援 Web Bluetooth
if (!navigator.bluetooth) {
    logStatus('❌ 瀏覽器不支援 Web Bluetooth。', 'error');
    btnConnect.disabled = true;
    btnConnect.querySelector('span').textContent = "不支援";
}
</script>
</body>
</html>