<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>è¨ªå®¢è¡Œç‚ºè¨˜éŒ„åˆ†æç³»çµ±</title>
    <style>
        /* --- é é¢ä½ˆå±€èˆ‡æ¨£å¼ --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f7f9; }
        .container { display: flex; gap: 20px; max-width: 1200px; margin: 0 auto; }
        .control-panel { flex: 1; min-width: 300px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .map-section { flex: 2; background-color: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }

        /* --- åœ°åœ–èˆ‡æ¨™è¨˜æ¨£å¼ --- */
        #map-container { 
            position: relative; 
            display: inline-block; 
            cursor: crosshair; 
            border: 1px solid #ccc;
        }
        #map-image { max-width: 100%; height: auto; display: block; }
        .marker {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: #007bff; /* è—è‰² */
            border-radius: 50%;
            border: 2px solid white;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
        }
        .marker:hover { background-color: #0056b3; }
        .marker-name {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .marker:hover .marker-name { opacity: 1; }

        /* --- è¡¨å–®æ§åˆ¶æ¨£å¼ --- */
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        select, input[type="text"] { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; transition: background-color 0.2s; }
        .primary-btn { background-color: #28a745; }
        .primary-btn:hover { background-color: #1e7e34; }

        /* --- è³‡æ–™åˆ—è¡¨æ¨£å¼ --- */
        #data-log { border: 1px solid #ccc; max-height: 250px; overflow-y: auto; padding: 10px; margin-top: 20px; background-color: #fff; }
        .log-item { border-bottom: 1px dashed #eee; padding: 8px 0; font-size: 14px; }
        .log-item:last-child { border-bottom: none; }
        .data-export-section { margin-top: 20px; text-align: right; }

    </style>
</head>
<body>

    <h1>ğŸ“Š è¨ªå®¢è¡Œç‚ºè¨˜éŒ„åˆ†æç³»çµ±</h1>
    <div class="container">
        
        <div class="control-panel">
            <h2>ğŸ“Œ è¨˜éŒ„æ§åˆ¶å°</h2>

            <div class="input-group">
                <label for="visitor-category-select">è¨ªå®¢åˆ†é¡</label>
                <select id="visitor-category-select"></select>
                <input type="text" id="new-category-input" placeholder="æ–°å¢è¨ªå®¢é¡åˆ¥åç¨±">
                <button onclick="addCategory()" class="primary-btn" style="width: 100%;">æ–°å¢æˆ–é¸æ“‡é¡åˆ¥</button>
            </div>

            <hr>

            <div class="input-group">
                <label for="action-select">è¡Œç‚ºè¨˜éŒ„</label>
                <select id="action-select"></select>
                <input type="text" id="new-action-input" placeholder="æ–°å¢è¡Œç‚ºåç¨±">
                <button onclick="addAction()" class="primary-btn" style="width: 100%;">æ–°å¢æˆ–é¸æ“‡è¡Œç‚º</button>
            </div>

            <hr>
            
            <h3>ç•¶å‰è¨˜éŒ„ç‹€æ…‹</h3>
            <p>åˆ†é¡: <strong id="current-category">æœªé¸æ“‡</strong></p>
            <p>ä½ç½®: <strong id="current-location">æœªé»æ“Š</strong></p>
            <p>è¡Œç‚º: <strong id="current-action">æœªé¸æ“‡</strong></p>
            <p>
                <button id="record-button" onclick="recordBehavior()" class="primary-btn" style="width: 100%; background-color: #dc3545;" disabled>
                    é–‹å§‹è¨˜éŒ„æ­¤è¡Œç‚º
                </button>
            </p>
        </div>

        <div class="map-section">
            
            <h2>ğŸ—ºï¸ ä½ç½®è¨˜éŒ„ (é»æ“Šåœ°åœ–)</h2>
            <div class="input-group">
                <label for="map-select">é¸æ“‡å¹³é¢åœ–</label>
                <select id="map-select">
                    <option value="çŠç‘šç‹åœ‹é¤¨å¹³é¢åœ–.jpg">çŠç‘šç‹åœ‹é¤¨å¹³é¢åœ–</option>
                </select>
            </div>

            <div id="map-container">
                <img id="map-image" src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/aeee9399-5776-4dc9-bc34-74f3de9610ad.jpg" alt="å¹³é¢åœ–">
            </div>

            <div class="data-export-section">
                <h3>ğŸ“œ è¨˜éŒ„æ—¥èªŒ</h3>
                <div id="data-log"></div>
                <button onclick="exportData()" class="primary-btn" style="margin-top: 10px;">åŒ¯å‡º Excel (CSV)</button>
            </div>
            
        </div>
    </div>

    <script>
        // --- è¨­å®š ---
        const DISTANCE_THRESHOLD = 10; // è·é›¢å®¹å¿åº¦ (10px)
        const CATEGORY_KEY = 'visitorCategories';
        const ACTION_KEY = 'visitorActions';
        const LOCATION_KEY = 'locationMarkers';
        const LOG_KEY = 'behaviorLog';
        
        // --- DOM å…ƒç´ å¿«å– ---
        const mapContainer = document.getElementById('map-container');
        const mapImage = document.getElementById('map-image');
        const categorySelect = document.getElementById('visitor-category-select');
        const actionSelect = document.getElementById('action-select');
        const dataLog = document.getElementById('data-log');
        const currentCategory = document.getElementById('current-category');
        const currentLocation = document.getElementById('current-location');
        const currentAction = document.getElementById('current-action');
        const recordButton = document.getElementById('record-button');

        // --- ç‹€æ…‹è®Šæ•¸ ---
        let locations = loadData(LOCATION_KEY);
        let categories = loadData(CATEGORY_KEY, ['ä¸€èˆ¬éŠå®¢', 'å­¸ç”Ÿåœ˜é«”', 'å¹´é•·è€…']); // é è¨­é¡åˆ¥
        let actions = loadData(ACTION_KEY, ['åœç•™è§€çœ‹', 'å¿«é€Ÿç§»å‹•', 'ä½¿ç”¨æ‰‹æ©Ÿ', 'äº’å‹•é«”é©—']); // é è¨­è¡Œç‚º
        let logData = loadData(LOG_KEY);

        let selectedCategory = '';
        let selectedLocation = '';
        let selectedAction = '';

        // --- è¼”åŠ©å‡½æ•¸ ---
        function loadData(key, defaultData = []) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : defaultData;
        }

        function saveData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }
        
        // æ­å¹¾é‡Œå¾—è·é›¢å¹³æ–¹
        function getDistanceSq(x1, y1, x2, y2) {
            return Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2);
        }

        // --- 1. è¨ªå®¢åˆ†é¡æ“ä½œæ­¥é©Ÿ ---
        function initCategory() {
            populateSelect(categorySelect, categories);
            categorySelect.onchange = () => {
                selectedCategory = categorySelect.value;
                currentCategory.textContent = selectedCategory;
                checkRecordButtonStatus();
            };
            if (categories.length > 0) {
                categorySelect.value = categories[0];
                categorySelect.onchange(); // è§¸ç™¼é¸æ“‡ç¬¬ä¸€å€‹é …ç›®
            }
        }

        function addCategory() {
            const input = document.getElementById('new-category-input');
            const newName = input.value.trim();
            
            if (newName && !categories.includes(newName)) {
                categories.push(newName);
                saveData(CATEGORY_KEY, categories);
                populateSelect(categorySelect, categories);
                categorySelect.value = newName;
            }
            // é¸æ“‡å·²æœ‰çš„æˆ–æ–°åŠ å…¥çš„
            selectedCategory = categorySelect.value || newName;
            currentCategory.textContent = selectedCategory;
            input.value = '';
            checkRecordButtonStatus();
        }

        // --- 3. è¡Œç‚ºè¨˜éŒ„æ“ä½œæ­¥é©Ÿ (èˆ‡åˆ†é¡é¡ä¼¼) ---
        function initAction() {
            populateSelect(actionSelect, actions);
            actionSelect.onchange = () => {
                selectedAction = actionSelect.value;
                currentAction.textContent = selectedAction;
                checkRecordButtonStatus();
            };
            if (actions.length > 0) {
                actionSelect.value = actions[0];
                actionSelect.onchange(); // è§¸ç™¼é¸æ“‡ç¬¬ä¸€å€‹é …ç›®
            }
        }

        function addAction() {
            const input = document.getElementById('new-action-input');
            const newName = input.value.trim();
            
            if (newName && !actions.includes(newName)) {
                actions.push(newName);
                saveData(ACTION_KEY, actions);
                populateSelect(actionSelect, actions);
                actionSelect.value = newName;
            }
            // é¸æ“‡å·²æœ‰çš„æˆ–æ–°åŠ å…¥çš„
            selectedAction = actionSelect.value || newName;
            currentAction.textContent = selectedAction;
            input.value = '';
            checkRecordButtonStatus();
        }

        // å¡«å……ä¸‹æ‹‰é¸å–®çš„é€šç”¨å‡½æ•¸
        function populateSelect(selectElement, data) {
            selectElement.innerHTML = '';
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                selectElement.appendChild(option);
            });
        }

        // --- 2. ä½ç½®æ“ä½œæ­¥é©Ÿ ---
        function renderMarkers() {
            // æ¸…ç©ºèˆŠçš„æ¨™è¨˜
            mapContainer.querySelectorAll('.marker').forEach(m => m.remove());

            locations.forEach((loc, index) => {
                const markerDiv = document.createElement('div');
                markerDiv.className = 'marker';
                markerDiv.style.left = `${loc.x}px`;
                markerDiv.style.top = `${loc.y}px`;
                markerDiv.dataset.index = index;
                markerDiv.title = `${loc.name} (${loc.x}, ${loc.y})`;

                const nameSpan = document.createElement('span');
                nameSpan.className = 'marker-name';
                nameSpan.textContent = loc.name;

                markerDiv.appendChild(nameSpan);
                mapContainer.appendChild(markerDiv);
            });
        }

        mapContainer.addEventListener('click', (event) => {
            const x = event.offsetX;
            const y = event.offsetY;
            const thresholdSq = Math.pow(DISTANCE_THRESHOLD, 2);

            let foundLocation = null;
            let closestDistanceSq = Infinity;

            // æª¢æŸ¥æ—¢æœ‰åç¨±ä¹‹åº§æ¨™æ˜¯å¦åœ¨è©²é»æ“Šåº§æ¨™æ–¹åœ“10pxå…§
            for (const loc of locations) {
                const distSq = getDistanceSq(x, y, loc.x, loc.y);
                if (distSq < closestDistanceSq) {
                    closestDistanceSq = distSq;
                    if (distSq <= thresholdSq) {
                        foundLocation = loc;
                    }
                }
            }

            if (foundLocation) {
                // å¦‚æœæ˜¯ï¼šé–‹å§‹è¡Œç‚ºè¨˜éŒ„ä½œæ¥­
                selectedLocation = foundLocation.name;
                alert(`å·²é¸æ“‡ä½ç½®ï¼š${selectedLocation}ã€‚è«‹é–‹å§‹è¨˜éŒ„è¡Œç‚ºã€‚`);
            } else {
                // å¦‚æœä¸æ˜¯ï¼šç‚ºè©²é»æ“Šçš„åº§æ¨™å‘½å
                const newName = prompt(`æ‚¨é»æ“Šçš„åº§æ¨™æ˜¯ (X: ${x}, Y: ${y})ã€‚è«‹ç‚ºé€™å€‹æ–°ä½ç½®å‘½åï¼š`);
                if (newName) {
                    const existingLoc = locations.find(loc => loc.name === newName);
                    if (existingLoc) {
                         alert(`ä½ç½®åç¨± "${newName}" å·²å­˜åœ¨ã€‚è«‹é‡æ–°å‘½åæˆ–é»æ“Šç¾æœ‰æ¨™è¨˜ã€‚`);
                    } else {
                        locations.push({ name: newName, x: x, y: y, map: document.getElementById('map-select').value });
                        saveData(LOCATION_KEY, locations);
                        renderMarkers();
                        selectedLocation = newName;
                        alert(`å·²æ–°å¢ä½ç½®ï¼š${selectedLocation}`);
                    }
                } else {
                    selectedLocation = ''; // æ¸…é™¤ä½ç½®
                    alert('å·²å–æ¶ˆå‘½åï¼Œè«‹é‡æ–°é»æ“Šã€‚');
                }
            }

            currentLocation.textContent = selectedLocation || 'æœªé»æ“Š';
            checkRecordButtonStatus();
        });

        // --- è¨˜éŒ„èˆ‡åŒ¯å‡º ---
        function checkRecordButtonStatus() {
            const isReady = selectedCategory && selectedLocation && selectedAction;
            recordButton.disabled = !isReady;
            recordButton.textContent = isReady ? `è¨˜éŒ„: ${selectedCategory} åœ¨ ${selectedLocation} çš„ ${selectedAction}` : 'è«‹å®Œæˆæ‰€æœ‰é¸æ“‡';
            recordButton.style.backgroundColor = isReady ? '#28a745' : '#dc3545';
        }

        function recordBehavior() {
            if (!selectedCategory || !selectedLocation || !selectedAction) {
                alert('è«‹å…ˆå®Œæˆ è¨ªå®¢åˆ†é¡ã€ä½ç½®é»æ“Š å’Œ è¡Œç‚ºè¨˜éŒ„ çš„é¸æ“‡ï¼');
                return;
            }

            const now = new Date();
            const timestamp = now.toLocaleString('zh-TW', { hour12: false });
            
            const newLog = {
                timestamp: timestamp,
                category: selectedCategory,
                location: selectedLocation,
                action: selectedAction,
                map: document.getElementById('map-select').value,
                // æ‰¾åˆ°åº§æ¨™
                coords: locations.find(loc => loc.name === selectedLocation) ? 
                        `(${locations.find(loc => loc.name === selectedLocation).x}, ${locations.find(loc => loc.name === selectedLocation).y})` : 'N/A'
            };

            logData.unshift(newLog); // åŠ åˆ°æœ€å‰é¢
            saveData(LOG_KEY, logData);
            renderLog();
            
            alert(`è¨˜éŒ„æˆåŠŸï¼\n[${timestamp}] ${newLog.category} åœ¨ ${newLog.location} åŸ·è¡Œ ${newLog.action}`);
        }

        function renderLog() {
            dataLog.innerHTML = '';
            if (logData.length === 0) {
                dataLog.innerHTML = 'å°šç„¡è¨˜éŒ„è³‡æ–™ã€‚';
                return;
            }
            logData.slice(0, 15).forEach(log => { // é¡¯ç¤ºæœ€æ–°çš„ 15 ç­†
                const item = document.createElement('div');
                item.className = 'log-item';
                item.textContent = `[${log.timestamp}] ${log.category} | ${log.location} | ${log.action}`;
                dataLog.appendChild(item);
            });
        }

        function exportData() {
            if (logData.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºã€‚');
                return;
            }

            // CSV æ¨™é ­
            let csv = "æ™‚é–“,è¨ªå®¢åˆ†é¡,ä½ç½®åç¨±,è¡Œç‚ºè¨˜éŒ„,åœ°åœ–,åº§æ¨™\n";

            // æ•¸æ“šè¡Œ
            logData.forEach(log => {
                // ç¢ºä¿æ•¸æ“šä¸­å¦‚æœå«æœ‰é€—è™Ÿï¼Œæœƒè¢«é›™å¼•è™ŸåŒ…ä½
                const row = [
                    `"${log.timestamp}"`,
                    `"${log.category}"`,
                    `"${log.location}"`,
                    `"${log.action}"`,
                    `"${log.map}"`,
                    `"${log.coords}"`
                ].join(",");
                csv += row + "\n";
            });

            // å»ºç«‹ Blob ç‰©ä»¶
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", "è¨ªå®¢è¡Œç‚ºè¨˜éŒ„.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- åˆå§‹åŒ–å…¨éƒ¨åŠŸèƒ½ ---
        function initApp() {
            initCategory();
            initAction();
            renderMarkers();
            renderLog();
            checkRecordButtonStatus();
        }

        // ç¢ºä¿åœ–ç‰‡è¼‰å…¥å¾Œå†åˆå§‹åŒ–ï¼Œä»¥ç²å¾—æ­£ç¢ºçš„åº§æ¨™è¨ˆç®—
        mapImage.onload = initApp;
        if (mapImage.complete) {
            initApp();
        }

    </script>
</body>
</html>