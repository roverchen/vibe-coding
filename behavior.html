<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”ç©¶ç´šï¼šåšç‰©é¤¨è§€çœ¾è¡Œç‚ºèˆ‡å‹•ç·šè¨˜éŒ„ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* åœ°åœ–å€åŸŸæ¨£å¼ */
        #map-container { 
            position: relative; 
            display: inline-block; 
            cursor: crosshair; 
            border: 2px solid #e2e8f0;
            background-color: #f8fafc;
            width: 100%; 
            overflow: hidden;
            border-radius: 8px;
        }
        .map-image { max-width: 100%; height: auto; display: none; }
        .map-image.active { display: block; }

        /* è»Œè·¡é» (Markers) æ¨£å¼ */
        .marker {
            position: absolute;
            width: 24px;
            height: 24px;
            background-color: #4f46e5; 
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            z-index: 20;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* è»Œè·¡é€£ç·š (Path Line) æ¨£å¼ */
        .path-line {
            position: absolute;
            height: 3px;
            background-color: #818cf8;
            z-index: 10;
            transform-origin: 0 50%;
            pointer-events: none;
            opacity: 0.6;
        }

        /* æ§åˆ¶é¢æ¿æ²è»¸ */
        .sticky-panel { position: sticky; top: 1rem; height: calc(100vh - 2rem); overflow-y: auto; }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-slate-800">ğŸ“Š è§€çœ¾è¡Œç‚ºç ”ç©¶è¨˜éŒ„ç³»çµ±</h1>
            <p class="text-slate-500 mt-2">ä¾æ“šã€Šåšç‰©é¤¨å…’ç«¥ç©ºé–“çš„å®¶é•·è¡Œç‚ºç ”ç©¶ã€‹æ–¹æ³•è«–è¨­è¨ˆ</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 sticky-panel space-y-6">
                    
                    <section>
                        <h2 class="text-lg font-bold text-indigo-700 mb-4 flex items-center">
                            <span class="mr-2">ğŸ‘¤</span> 1. è§€å¯Ÿå€‹æ¡ˆè³‡è¨Š
                        </h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">è§€å¯Ÿç·¨è™Ÿ (Session ID)</label>
                                <input type="text" id="session-id" placeholder="ä¾‹å¦‚: 20230712-01" 
                                       class="w-full p-2 border rounded-md bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">åœ˜é«”æˆå“¡çµ„åˆ (Group Composition)</label>
                                <select id="group-type-select" class="w-full p-2 border rounded-md">
                                    <option value="1å¤§1å°">1æˆäºº + 1å…’ç«¥ (1A1C)</option>
                                    <option value="1å¤§2å°">1æˆäºº + 2å…’ç«¥ (1A2C)</option>
                                    <option value="2å¤§1å°">2æˆäºº + 1å…’ç«¥ (2A1C)</option>
                                    <option value="2å¤§2å°">2æˆäºº + 2å…’ç«¥ (2A2C)</option>
                                    <option value="å…¶ä»–çµ„åˆ">å…¶ä»–çµ„åˆ</option>
                                </select>
                            </div>
                        </div>
                    </section>

                    <hr class="border-slate-100">

                    <section>
                        <h2 class="text-lg font-bold text-indigo-700 mb-4 flex items-center">
                            <span class="mr-2">ğŸ“</span> 2. è¡Œç‚ºç´€éŒ„
                        </h2>
                        <div class="space-y-4">
                            <label class="block text-sm font-medium text-slate-700 mb-1">ç•¶å‰è§€å¯Ÿè¡Œç‚º (Behavioral Coding)</label>
                            <select id="action-select" class="w-full p-2 border rounded-md mb-2">
                                <optgroup label="äº’å‹•è¡Œç‚º (Interactive)">
                                    <option value="å…±åŒåƒèˆ‡">å…±åŒåƒèˆ‡ (å…±åŒæ“ä½œå±•å“)</option>
                                    <option value="å¼•å°èªªæ˜">å¼•å°èªªæ˜ (è§£é‡‹/å°è©±)</option>
                                    <option value="é«”åŠ›æ”¯æ´">é«”åŠ›æ”¯æ´ (å”åŠ©/æç‰©)</option>
                                    <option value="è¢«å‹•éš¨è¡Œ">è¢«å‹•éš¨è¡Œ (è¿‘è·é›¢è§€å¯Ÿ)</option>
                                </optgroup>
                                <optgroup label="éäº’å‹•è¡Œç‚º (Non-Interactive)">
                                    <option value="æ‹ç…§éŒ„å½±">æ‹ç…§éŒ„å½±</option>
                                    <option value="è™•ç†ç§äº‹">è™•ç†ç§äº‹ (æ»‘æ‰‹æ©Ÿ/äº¤è«‡)</option>
                                    <option value="ä¼‘æ¯ç­‰å¾…">ä¼‘æ¯ç­‰å¾…</option>
                                </optgroup>
                            </select>
                        </div>
                    </section>

                    <section class="bg-indigo-50 p-4 rounded-lg">
                        <h3 class="font-bold text-indigo-800 mb-2 text-sm">ç•¶å‰è¿½è¹¤ç‹€æ…‹</h3>
                        <div class="text-xs space-y-1 text-indigo-700">
                            <p>ä½ç½®: <span id="display-location" class="font-bold">å°šæœªé»æ“Šåœ°åœ–</span></p>
                            <p>è»Œè·¡é †åº: <span id="display-sequence" class="font-bold">ç¬¬ 0 é»</span></p>
                        </div>
                        <button id="record-btn" onclick="recordPoint()" disabled
                                class="w-full mt-4 bg-indigo-600 text-white font-bold py-3 rounded-md shadow-md disabled:bg-slate-300 transition-all hover:bg-indigo-700">
                            è¨˜éŒ„æ­¤ç¯€é»èˆ‡è¡Œç‚º
                        </button>
                    </section>

                    <div class="pt-4 flex flex-col gap-2">
                        <button onclick="finishSession()" class="w-full border-2 border-slate-300 text-slate-600 font-bold py-2 rounded-md hover:bg-slate-100">
                            ğŸ çµæŸæ­¤å€‹æ¡ˆè§€å¯Ÿ (æ¸…é™¤å‹•ç·š)
                        </button>
                        <a href="log-viewer.html" class="block text-center text-sm text-indigo-600 hover:underline">
                            æŸ¥çœ‹æ­·ç¨‹ç´€éŒ„èˆ‡æ•¸æ“šåŒ¯å‡º
                        </a>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <h2 class="text-xl font-bold text-slate-700">ğŸ—ºï¸ ä½ç½®ç´€éŒ„èˆ‡å‹•ç·šè¿½è¹¤</h2>
                        <select id="map-select" class="p-2 border rounded-md text-sm bg-slate-50">
                            <option value="map-1">å…’è—åŸºåœ° - å€åŸŸ A</option>
                            <option value="map-2">å…’è—åŸºåœ° - å€åŸŸ B</option>
                        </select>
                    </div>

                    <div id="map-container">
                        <img id="map-1" class="map-image active" src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/f9f83808-8917-4d91-be95-98955736b763.jpg" alt="å…’è—åŸºåœ°å¹³é¢åœ–">
                        <img id="map-2" class="map-image" src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/be3ac2e6-4910-4308-9c19-d797081ea4e1.jpg" alt="å…’è—åŸºåœ°å¹³é¢åœ–2">
                    </div>
                    <p class="mt-2 text-xs text-slate-400 font-mono">â€» é»æ“Šåœ°åœ–ä»¥è¨­å®šè§€çœ¾æ‰€åœ¨ä½ç½®åº§æ¨™</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- è¨­å®šèˆ‡å„²å­˜é‡‘é‘° ---
        const LOG_KEY = 'museum_research_logs';
        
        // --- ç‹€æ…‹ç®¡ç† ---
        let currentPath = []; // å„²å­˜ç•¶å‰å€‹æ¡ˆçš„å‹•ç·šé»
        let lastSelectedCoord = null;
        let logs = JSON.parse(localStorage.getItem(LOG_KEY) || '[]');

        const mapContainer = document.getElementById('map-container');
        const recordBtn = document.getElementById('record-btn');
        const displayLocation = document.getElementById('display-location');
        const displaySequence = document.getElementById('display-sequence');

        // --- 1. åœ°åœ–é»æ“Šé‚è¼¯ ---
        mapContainer.addEventListener('click', (e) => {
            const rect = mapContainer.getBoundingClientRect();
            const x = Math.round(e.clientX - rect.left);
            const y = Math.round(e.clientY - rect.top);
            
            lastSelectedCoord = { x, y };
            displayLocation.textContent = `åº§æ¨™: (${x}, ${y})`;
            
            renderVisuals();
            recordBtn.disabled = false;
        });

        // --- 2. è¨˜éŒ„è¡Œç‚ºé» (è»Œè·¡ç¯€é») ---
        function recordPoint() {
            const sessionId = document.getElementById('session-id').value || 'æœªç·¨è™Ÿ';
            const groupType = document.getElementById('group-type-select').value;
            const action = document.getElementById('action-select').value;
            
            if (!lastSelectedCoord) return;

            const pointData = {
                sessionId: sessionId,
                groupType: groupType,
                timestamp: new Date().toISOString(),
                sequence: currentPath.length + 1,
                action: action,
                x: lastSelectedCoord.x,
                y: lastSelectedCoord.y,
                map: document.getElementById('map-select').value
            };

            // å„²å­˜è‡³æš«æ™‚è·¯å¾‘èˆ‡æŒä¹…æ—¥èªŒ
            currentPath.push(pointData);
            logs.unshift(pointData);
            localStorage.setItem(LOG_KEY, JSON.stringify(logs));

            // æ›´æ–° UI
            displaySequence.textContent = `ç¬¬ ${currentPath.length} é»`;
            lastSelectedCoord = null;
            recordBtn.disabled = true;
            renderVisuals();
            
            console.log("å·²è¨˜éŒ„ç¯€é»:", pointData);
        }

        // --- 3. è¦–è¦ºåŒ–æ¸²æŸ“ (Markers & Lines) ---
        function renderVisuals() {
            // æ¸…é™¤èˆŠæœ‰çš„è¦–è¦ºå…ƒç´ 
            mapContainer.querySelectorAll('.marker, .path-line, .temp-marker').forEach(el => el.remove());

            // A. ç¹ªè£½å·²å„²å­˜çš„è·¯å¾‘é€£ç·š (Trajectory Lines)
            for (let i = 0; i < currentPath.length - 1; i++) {
                const start = currentPath[i];
                const end = currentPath[i+1];
                drawLine(start.x, start.y, end.x, end.y);
            }

            // B. ç¹ªè£½è»Œè·¡é» (Markers)
            currentPath.forEach((p, idx) => {
                const marker = document.createElement('div');
                marker.className = 'marker';
                marker.style.left = p.x + 'px';
                marker.style.top = p.y + 'px';
                marker.textContent = p.sequence;
                marker.title = `${p.action} (${p.groupType})`;
                mapContainer.appendChild(marker);
            });

            // C. ç¹ªè£½ç•¶å‰é¸å–é» (å°šæœªè¨˜éŒ„çš„é»)
            if (lastSelectedCoord) {
                const temp = document.createElement('div');
                temp.className = 'marker temp-marker';
                temp.style.left = lastSelectedCoord.x + 'px';
                temp.style.top = lastSelectedCoord.y + 'px';
                temp.style.backgroundColor = '#ef4444'; // ç´…è‰²è¡¨ç¤ºé å‚™é»
                temp.textContent = '?';
                mapContainer.appendChild(temp);
            }
        }

        // ç¹ªç·šå·¥å…·å‡½å¼
        function drawLine(x1, y1, x2, y2) {
            const line = document.createElement('div');
            line.className = 'path-line';
            const distance = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
            const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;

            line.style.width = distance + 'px';
            line.style.left = x1 + 'px';
            line.style.top = y1 + 'px';
            line.style.transform = `rotate(${angle}deg)`;
            mapContainer.appendChild(line);
        }

        // --- 4. çµæŸå€‹æ¡ˆ ---
        function finishSession() {
            if (confirm("ç¢ºå®šè¦çµæŸæ­¤å€‹æ¡ˆè§€å¯Ÿå—ï¼Ÿé€™å°‡æœƒæ¸…é™¤ç•«é¢ä¸Šçš„è·¯å¾‘åœ–ä»¥é€²è¡Œä¸‹ä¸€çµ„è§€å¯Ÿã€‚")) {
                currentPath = [];
                lastSelectedCoord = null;
                document.getElementById('session-id').value = '';
                displayLocation.textContent = 'å°šæœªé»æ“Šåœ°åœ–';
                displaySequence.textContent = 'ç¬¬ 0 é»';
                renderVisuals();
            }
        }

        // --- 5. åœ°åœ–åˆ‡æ› ---
        document.getElementById('map-select').addEventListener('change', (e) => {
            document.querySelectorAll('.map-image').forEach(img => img.classList.remove('active'));
            document.getElementById(e.target.value).classList.add('active');
            // åˆ‡æ›åœ°åœ–æ™‚å»ºè­°æ¸…é™¤ç•¶å‰è·¯å¾‘ï¼Œå› ç‚ºåº§æ¨™ç³»ä¸åŒ
            currentPath = [];
            renderVisuals();
        });
    </script>
</body>
</html>